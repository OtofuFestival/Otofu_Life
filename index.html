<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„Åä„Å®„Äú„Åµ‰∏ÄÁîü</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            min-height: 100%;
            overflow: hidden;
            position: relative;
            transition: background 1s ease;
        }

        /* Portrait-safe viewport wrapper (prevents sideways layout on Android fullscreen) */
        #viewport {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Let the body's background (night-bg / day-bg etc.) show through.
               Using a solid color here can make the background look "black" on some devices. */
            background: transparent;
        }

        #app {
            width: 100%;
            height: 100%;
            transform-origin: center center;
            will-change: transform, width, height;
        }

        
        body.night-bg {
            background: 
                radial-gradient(ellipse at top, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                linear-gradient(135deg, 
                    #0a0e27 0%, 
                    #16213e 20%,
                    #1a1a40 40%,
                    #0f1b3d 60%,
                    #1e1e3f 80%,
                    #0a0e27 100%);
            background-size: 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 20s ease infinite;
        }
        
        body.snow-bg {
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(230, 245, 255, 0.7) 0%, transparent 30%),
                radial-gradient(ellipse at 80% 70%, rgba(180, 220, 255, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(210, 235, 255, 0.4) 0%, transparent 50%),
                linear-gradient(180deg, 
                    #e8f4ff 0%,
                    #def0ff 6%,
                    #d4ecff 12%,
                    #cae8ff 18%,
                    #c0e4ff 24%,
                    #b6e0ff 30%,
                    #acdcff 36%,
                    #a2d8ff 42%,
                    #98d4ff 48%,
                    #8ed0ff 54%,
                    #84ccff 60%,
                    #7ac8ff 66%,
                    #70c4ff 72%,
                    #66c0ff 78%,
                    #5cbcff 84%,
                    #52b8ff 90%,
                    #48b4ff 96%,
                    #3eb0ff 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.forest-bg {
            background: 
                radial-gradient(ellipse at 25% 15%, rgba(150, 220, 120, 0.7) 0%, transparent 35%),
                radial-gradient(ellipse at 75% 75%, rgba(60, 140, 60, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(100, 180, 90, 0.4) 0%, transparent 50%),
                linear-gradient(180deg, 
                    #6fb350 0%,
                    #62a045 6%,
                    #568d3b 12%,
                    #4a7a32 18%,
                    #3f6829 24%,
                    #355621 30%,
                    #2c4619 36%,
                    #243713 42%,
                    #1d290e 48%,
                    #171e0a 54%,
                    #121508 60%,
                    #0e0f06 66%,
                    #0b0b05 72%,
                    #090804 78%,
                    #070603 84%,
                    #050402 90%,
                    #040302 96%,
                    #020201 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.rain-bg {
            background: 
                radial-gradient(ellipse at 30% 25%, rgba(150, 180, 220, 0.6) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 70%, rgba(100, 130, 180, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(120, 150, 200, 0.4) 0%, transparent 50%),
                linear-gradient(180deg, 
                    #708090 0%,
                    #657585 8%,
                    #5a6a7a 16%,
                    #4f5f6f 24%,
                    #445464 32%,
                    #394959 40%,
                    #2e3e4e 48%,
                    #233343 56%,
                    #182838 64%,
                    #0d1d2d 72%,
                    #021222 80%,
                    #000717 88%,
                    #00020c 96%,
                    #000001 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.rainbow-bg {
            background: 
                radial-gradient(ellipse at 15% 20%, rgba(255, 0, 100, 0.6) 0%, transparent 35%),
                radial-gradient(ellipse at 85% 25%, rgba(100, 0, 255, 0.6) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 150, 0.5) 0%, transparent 40%),
                radial-gradient(ellipse at 30% 70%, rgba(255, 200, 0, 0.5) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 75%, rgba(0, 150, 255, 0.5) 0%, transparent 35%),
                linear-gradient(180deg, 
                    #ff1493 0%,
                    #ff3d8f 6%,
                    #ff5c8a 12%,
                    #ff7a86 18%,
                    #ff9981 24%,
                    #ffb87d 30%,
                    #ffd678 36%,
                    #fff573 42%,
                    #e8ff6f 48%,
                    #c8ff6f 54%,
                    #a8ff73 60%,
                    #88ff7d 66%,
                    #68ff8d 72%,
                    #48ffa3 78%,
                    #48e8ff 84%,
                    #48c8ff 90%,
                    #5c9dff 96%,
                    #7a6fff 100%);
            background-size: 100% 100%;
        }
        
        body.dream-bg {
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(255, 100, 150, 0.5) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 40%, rgba(100, 150, 255, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 50% 60%, rgba(150, 255, 150, 0.4) 0%, transparent 45%),
                linear-gradient(180deg, 
                    #ff6b9d 0%,
                    #ff8ba7 7%,
                    #ffa8b4 14%,
                    #ffc4c4 21%,
                    #ffddcc 28%,
                    #fff4d4 35%,
                    #ffffdd 42%,
                    #e8ffdd 49%,
                    #d4ffdd 56%,
                    #c4ffe8 63%,
                    #b4f4ff 70%,
                    #a8ddff 77%,
                    #9dc4ff 84%,
                    #9da8ff 91%,
                    #a89dff 98%,
                    #b49dff 100%);
            background-size: 100% 100%;
        }
        
        body.sakura-bg {
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(255, 200, 220, 0.7) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 75%, rgba(255, 180, 210, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255, 220, 230, 0.4) 0%, transparent 50%),
                linear-gradient(180deg, 
                    #ffe8f0 0%,
                    #ffd8e8 8%,
                    #ffc8e0 16%,
                    #ffb8d8 24%,
                    #ffa8d0 32%,
                    #ff98c8 40%,
                    #ff88c0 48%,
                    #ff78b8 56%,
                    #ff68b0 64%,
                    #ff58a8 72%,
                    #ff48a0 80%,
                    #ff3898 88%,
                    #ff2890 96%,
                    #ff1888 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.earth-bg {
            background: 
                radial-gradient(ellipse at 30% 30%, rgba(0, 150, 255, 0.7) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 60%, rgba(50, 220, 50, 0.7) 0%, transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(0, 200, 120, 0.6) 0%, transparent 45%),
                radial-gradient(ellipse at 45% 50%, rgba(160, 82, 45, 0.6) 0%, transparent 38%),
                linear-gradient(180deg, 
                    #001a33 0%,      /* Ê∑±„ÅÑÁ¥∫Ëâ≤ */
                    #003366 3%,      /* ÊøÉÁ¥∫ */
                    #004d99 6%,      /* ÊøÉ„ÅÑÈùí */
                    #0066cc 9%,      /* Èùí */
                    #0080ff 12%,     /* Êòé„Çã„ÅÑÈùí */
                    #0099ff 15%,     /* Ê∞¥Ëâ≤ */
                    #00aaff 18%,     /* Êòé„Çã„ÅÑÊ∞¥Ëâ≤ */
                    #00bbff 21%,     /* ÈÆÆ„ÇÑ„Åã„Å™Ê∞¥Ëâ≤ */
                    #11ccee 24%,     /* ÈùíÁ∑ë */
                    #22ddcc 27%,     /* „Ç®„É°„É©„É´„Éâ */
                    #33eeaa 30%,     /* Á∑ëÈùí */
                    #22cc66 33%,     /* ÊøÉ„ÅÑÁ∑ë */
                    #228844 36%,     /* Ê∑±Á∑ë */
                    #116622 39%,     /* Ê£ÆÊûó„ÅÆÁ∑ë */
                    #004400 42%,     /* ÊúÄ„ÇÇÊøÉ„ÅÑÁ∑ë */
                    #226633 45%,     /* Ê∑±Á∑ë */
                    #44aa55 48%,     /* Á∑ë */
                    #55dd66 51%,     /* Êòé„Çã„ÅÑÁ∑ë */
                    #66ff77 54%,     /* ÈÆÆ„ÇÑ„Åã„Å™Á∑ë */
                    #77dd55 57%,     /* ÈªÑÁ∑ë */
                    #88aa44 60%,     /* „Åè„Åô„Çì„Å†ÈªÑÁ∑ë */
                    #998833 63%,     /* ÈªÑÂúüËâ≤ */
                    #aa7744 66%,     /* Ëå∂Ëâ≤ */
                    #bb6633 69%,     /* ÊøÉ„ÅÑËå∂Ëâ≤ */
                    #cc5522 72%,     /* Ëµ§Ëå∂Ëâ≤ */
                    #dd4411 75%,     /* Ëµ§„Åø„ÅÆËå∂Ëâ≤ */
                    #cc5522 78%,     /* Ëå∂Ëâ≤ */
                    #bb5533 81%,     /* Ê∑±„ÅÑËå∂Ëâ≤ */
                    #aa5544 84%,     /* Êöó„ÅÑËå∂Ëâ≤ */
                    #995555 87%,     /* „Åè„Åô„Çì„Å†Ëå∂Ëâ≤ */
                    #886655 90%,     /* Ê∑±„ÅÑËå∂Ëâ≤ */
                    #775544 93%,     /* ÊúÄ„ÇÇÊøÉ„ÅÑËå∂Ëâ≤ */
                    #664433 96%,     /* ÊöóË§êËâ≤ */
                    #553322 100%);   /* „ÉÄ„Éº„ÇØ„Éñ„É©„Ç¶„É≥ */
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.toilet-bg {
            background: 
                radial-gradient(ellipse at 40% 25%, rgba(139, 90, 43, 0.5) 0%, transparent 35%),
                radial-gradient(ellipse at 60% 70%, rgba(160, 105, 60, 0.4) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(205, 133, 63, 0.3) 0%, transparent 50%),
                linear-gradient(180deg, 
                    #8b6914 0%,
                    #9d7726 10%,
                    #af8538 20%,
                    #c1934a 30%,
                    #d3a15c 40%,
                    #c4956f 50%,
                    #b58982 60%,
                    #a67d95 70%,
                    #9771a8 80%,
                    #8865bb 90%,
                    #7959ce 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 22s ease infinite;
        }
        
        body.music-bg {
            background: 
                radial-gradient(ellipse at 30% 30%, rgba(138, 43, 226, 0.6) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 60%, rgba(186, 85, 211, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(147, 112, 219, 0.4) 0%, transparent 45%),
                linear-gradient(180deg, 
                    #4a148c 0%,
                    #5e1a9e 10%,
                    #7220b0 15%,
                    #8626c2 20%,
                    #9a2cd4 25%,
                    #ae32e6 30%,
                    #9c27b0 35%,
                    #8a1c9a 40%,
                    #781184 45%,
                    #66066e 50%,
                    #7820a0 55%,
                    #8a3ab2 60%,
                    #9c54c4 65%,
                    #ae6ed6 70%,
                    #c088e8 75%,
                    #d2a2fa 80%,
                    #c896ec 85%,
                    #be8ade 90%,
                    #b47ed0 95%,
                    #aa72c2 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 18s ease infinite;
        }
        
        body.love-bg {
            background: 
                radial-gradient(ellipse at 30% 30%, rgba(255, 105, 180, 0.7) 0%, transparent 35%),
                radial-gradient(ellipse at 70% 60%, rgba(255, 20, 100, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(255, 60, 120, 0.5) 0%, transparent 45%),
                linear-gradient(180deg, 
                    #ff69b4 0%,
                    #ff5ca8 8%,
                    #ff4f9c 16%,
                    #ff4290 24%,
                    #ff3584 32%,
                    #ff2878 40%,
                    #ff1b6c 48%,
                    #ff0e60 56%,
                    #ff0154 64%,
                    #ee0050 72%,
                    #dd004c 80%,
                    #cc0048 88%,
                    #bb0044 96%,
                    #aa0040 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 20s ease infinite;
        }
        
        body.city-bg {
            background: 
                radial-gradient(ellipse at 50% 40%, rgba(255, 140, 80, 0.6) 0%, transparent 35%),
                radial-gradient(ellipse at 30% 80%, rgba(140, 100, 200, 0.5) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 20%, rgba(180, 120, 220, 0.4) 0%, transparent 45%),
                linear-gradient(180deg, 
                    #ff9966 0%,
                    #f58855 8%,
                    #eb7744 16%,
                    #e16633 24%,
                    #d75522 32%,
                    #ba4a33 40%,
                    #9d3f44 48%,
                    #803455 56%,
                    #632966 64%,
                    #461e77 72%,
                    #2a1555 80%,
                    #1f1144 88%,
                    #140d33 96%,
                    #0a0922 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.lava-bg {
            background: 
                radial-gradient(ellipse at 40% 30%, rgba(255, 100, 0, 0.8) 0%, transparent 30%),
                radial-gradient(ellipse at 60% 70%, rgba(255, 50, 0, 0.7) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, rgba(255, 150, 50, 0.5) 0%, transparent 45%),
                linear-gradient(180deg, 
                    #ff6600 0%,
                    #ff5500 6%,
                    #ff4400 12%,
                    #ff3300 18%,
                    #ff2200 24%,
                    #ee1100 30%,
                    #cc1100 36%,
                    #aa0f00 42%,
                    #880d00 48%,
                    #660b00 54%,
                    #440900 60%,
                    #330700 66%,
                    #220500 72%,
                    #110300 78%,
                    #0a0200 84%,
                    #050100 90%,
                    #020100 96%,
                    #000000 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 25s ease infinite;
        }
        
        body.aurora-bg {
            background: 
                radial-gradient(ellipse at 25% 25%, rgba(0, 255, 150, 0.6) 0%, transparent 35%),
                radial-gradient(ellipse at 75% 55%, rgba(100, 50, 255, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 50% 35%, rgba(0, 200, 255, 0.5) 0%, transparent 45%),
                radial-gradient(ellipse at 40% 70%, rgba(255, 50, 200, 0.4) 0%, transparent 40%),
                linear-gradient(180deg, 
                    #0d1f3a 0%,
                    #0a1b33 10%,
                    #08172c 20%,
                    #061325 30%,
                    #050f1e 40%,
                    #030b17 50%,
                    #020710 60%,
                    #01050c 70%,
                    #010308 80%,
                    #000204 90%,
                    #000000 100%);
            background-size: 100% 100%;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.12) 0%, transparent 35%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.12) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.08) 0%, transparent 45%),
                radial-gradient(circle at 40% 60%, rgba(236, 72, 153, 0.08) 0%, transparent 40%);
            animation: pulseGlow 10s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 0%, 0% 0%, 0% 50%; }
            50% { background-position: 0% 0%, 0% 0%, 100% 50%; }
        }
        
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* allow tapping HUD buttons */
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Èõ™„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
        .snowflake {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: snowfall linear infinite;
        }
        
        @keyframes snowfall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100dvh) rotate(360deg);
                opacity: 0.3;
            }
        }
        
        /* Èõ™„ÅÆÁµêÊô∂„Ç®„Éï„Çß„ÇØ„Éà */
        .snowcrystal {
            position: absolute;
            width: 16px;
            height: 16px;
            color: #a0d8ff;
            font-size: 16px;
            opacity: 0.9;
            animation: crystalfall linear infinite;
            text-shadow: 0 0 5px rgba(160, 216, 255, 0.8);
        }
        
        @keyframes crystalfall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.9;
            }
            100% {
                transform: translateY(100dvh) rotate(360deg);
                opacity: 0.4;
            }
        }
        
        /* Èõ®„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
        .raindrop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(150, 200, 255, 0.8), rgba(100, 150, 255, 0.3));
            opacity: 0.7;
            animation: rainfall linear infinite;
        }
        
        @keyframes rainfall {
            0% {
                transform: translateY(-30px);
                opacity: 0.7;
            }
            100% {
                transform: translateY(100dvh);
                opacity: 0.3;
            }
        }
        
        /* ÊÅã„ÅÆ„Éè„Éº„Éà„Ç®„Éï„Çß„ÇØ„Éà */
        .heart {
            position: absolute;
            opacity: 0.85;
            animation: heartfall linear infinite;
        }
        
        .heart.pink-heart {
            color: #ff69b4;
            text-shadow: 0 0 8px rgba(255, 105, 180, 0.6);
        }
        
        .heart.red-heart {
            color: #ff1744;
            text-shadow: 0 0 8px rgba(255, 23, 68, 0.6);
        }
        
        @keyframes heartfall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.7;
            }
            50% {
                transform: translateY(50vh) rotate(180deg);
                opacity: 0.85;
            }
            100% {
                transform: translateY(100dvh) rotate(360deg);
                opacity: 0.3;
            }
        }
        
        /* Ê£Æ„ÅÆËëâ„Å£„Å±„Ç®„Éï„Çß„ÇØ„Éà */
        .leaf {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 0 100% 0 100%;
            opacity: 0.85;
            animation: leaffall linear infinite;
        }
        
        /* ÊøÉ„ÅÑÁ∑ë„ÅÆËëâ */
        .leaf.dark-green {
            background: linear-gradient(45deg, #2d5016, #1a3010);
        }
        
        /* ‰∏≠ÈñìËâ≤„ÅÆËëâ */
        .leaf.medium-green {
            background: linear-gradient(45deg, #4a7c2e, #2d5016);
        }
        
        /* Êòé„Çã„ÅÑÁ∑ë„ÅÆËëâ */
        .leaf.light-green {
            background: linear-gradient(45deg, #90EE90, #228B22);
        }
        
        /* Âú∞ÁêÉ„ÅÆÈùí„ÅÑËëâÔºàÊøÉ„ÅÑ„ÇÅÔºâ */
        .leaf.earth-blue {
            background: linear-gradient(45deg, #0088ff, #0055cc);
        }
        
        /* Âú∞ÁêÉ„ÅÆÁ∑ë„ÅÆËëâÔºàÊøÉ„ÅÑ„ÇÅÔºâ */
        .leaf.earth-green {
            background: linear-gradient(45deg, #33cc33, #118811);
        }
        
        /* Âú∞ÁêÉ„ÅÆÈùíÁ∑ë„ÅÆËëâÔºàÊøÉ„ÅÑ„ÇÅÔºâ */
        .leaf.earth-teal {
            background: linear-gradient(45deg, #00aa88, #008866);
        }
        
        @keyframes leaffall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.7;
            }
            50% {
                transform: translateY(50vh) rotate(180deg);
                opacity: 0.5;
            }
            100% {
                transform: translateY(100dvh) rotate(360deg);
                opacity: 0.2;
            }
        }
        
        /* Ê°ú„ÅÆËä±„Å≥„Çâ„Ç®„Éï„Çß„ÇØ„Éà */
        .petal {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50% 0 50% 0;
            opacity: 0.8;
            animation: petalfall linear infinite;
        }
        
        /* ÊøÉ„ÅÑ„Éî„É≥„ÇØ„ÅÆËä±„Å≥„Çâ ‚Üí Ê°ú„ÅÆËëâ„Å£„Å±„ÅÆÁ∑ë */
        .petal.dark-pink {
            background: linear-gradient(45deg, #88cc88, #5a9e5a);
        }
        
        /* ‰∏≠ÈñìËâ≤„ÅÆËä±„Å≥„Çâ */
        .petal.medium-pink {
            background: linear-gradient(45deg, #ffb3d9, #ff85c1);
        }
        
        /* ÁôΩ„Å£„ÅΩ„ÅÑËä±„Å≥„Çâ */
        .petal.light-pink {
            background: linear-gradient(45deg, #ffe4f0, #ffc0e0);
        }
        
        @keyframes petalfall {
            0% {
                transform: translateY(-10px) rotate(0deg) translateX(0);
                opacity: 0.8;
            }
            50% {
                transform: translateY(50vh) rotate(180deg) translateX(30px);
                opacity: 0.6;
            }
            100% {
                transform: translateY(100dvh) rotate(360deg) translateX(0);
                opacity: 0.2;
            }
        }
        
        /* ÈÉΩ‰ºö„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
        .city-light {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 200, 100, 0.8);
            border-radius: 50%;
            animation: cityTwinkle 2s infinite;
            box-shadow: 0 0 10px rgba(255, 200, 100, 0.6);
        }
        
        @keyframes cityTwinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Ê∫∂Â≤©„ÅÆÁÅ´Ëä±„Ç®„Éï„Çß„ÇØ„Éà */
        .spark {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #ffcc00, #ff3300);
            border-radius: 50%;
            opacity: 0.9;
            box-shadow: 0 0 10px #ff6600;
            animation: sparkRise linear infinite;
        }
        
        @keyframes sparkRise {
            0% {
                transform: translateY(100dvh) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) scale(0.7);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-50px) scale(0.3);
                opacity: 0;
            }
        }
        
        /* Ê∫∂Â≤©„ÅÆÈªí„ÅÑÁÖô„ÉªÁÅ∞„Ç®„Éï„Çß„ÇØ„Éà */
        .lava-smoke {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(50, 50, 50, 0.7), transparent);
            border-radius: 50%;
            opacity: 0.6;
            animation: smokeRise linear infinite;
        }
        
        @keyframes smokeRise {
            0% {
                transform: translateY(100dvh) scale(0.5);
                opacity: 0.8;
            }
            50% {
                transform: translateY(50vh) scale(1.5);
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100px) scale(2.5);
                opacity: 0;
            }
        }
        
        /* Ê∫∂Â≤©„ÅÆÂ°ä„Ç®„Éï„Çß„ÇØ„Éà */
        .lava-chunk {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ff4400, #330000);
            border-radius: 40% 60% 50% 50%;
            opacity: 0.9;
            animation: chunkRise linear infinite;
        }
        
        @keyframes chunkRise {
            0% {
                transform: translateY(100dvh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* „Ç™„Éº„É≠„É©„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
        .aurora-wave {
            position: absolute;
            width: 180px;
            height: 100%;
            background: linear-gradient(180deg, 
                transparent 0%,
                rgba(0, 255, 150, 0.5) 15%,
                rgba(0, 200, 255, 0.6) 30%,
                rgba(100, 50, 255, 0.6) 45%,
                rgba(255, 50, 200, 0.5) 60%,
                rgba(0, 255, 180, 0.5) 75%,
                rgba(50, 150, 255, 0.4) 85%,
                transparent 100%);
            opacity: 0.5;
            filter: blur(35px);
            animation: auroraGlow 12s ease-in-out infinite;
        }
        
        @keyframes auroraGlow {
            0%, 100% {
                opacity: 0.3;
                transform: scaleX(0.9) scaleY(1);
            }
            33% {
                opacity: 0.7;
                transform: scaleX(1.3) scaleY(1.05);
            }
            66% {
                opacity: 0.5;
                transform: scaleX(1.1) scaleY(0.95);
            }
        }
        
        /* Êµ∑„ÅÆÊ≥°„Ç®„Éï„Çß„ÇØ„Éà */
        .bubble {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(100, 200, 255, 0.3));
            border-radius: 50%;
            animation: bubbleRise linear infinite;
        }
        
        /* Âú∞ÁêÉ„ÅÆÊ≥°ÔºàÈùíÁ∑ëÁ≥ªÔºâ */
        .bubble.earth-bubble {
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.7), rgba(50, 200, 150, 0.4));
        }
        
        /* „Éà„Ç§„É¨„ÅÆÊ≥°ÔºàËå∂Ëâ≤Á≥ªÔºâ */
        .bubble.toilet-bubble {
            background: radial-gradient(circle at 30% 30%, rgba(255, 240, 200, 0.6), rgba(139, 90, 43, 0.5));
        }
        
        @keyframes bubbleRise {
            0% {
                transform: translateY(100dvh) scale(0.5);
                opacity: 0;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-50px) scale(1);
                opacity: 0;
            }
        }
        
        /* Ê∫ÄÊúà„ÅÆÊúàÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
        .moonbeam {
            position: absolute;
            width: 2px;
            height: 30px;
            background: linear-gradient(to bottom, rgba(255, 255, 200, 0.5), transparent);
            animation: moonbeamFall linear infinite;
        }
        
        @keyframes moonbeamFall {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(100dvh);
                opacity: 0;
            }
        }
        
        /* Ëôπ„ÅÆÂÖâ„ÅÆÁ≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„Éà */
        .rainbow-particle {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            opacity: 0.8;
            animation: rainbowFloat linear infinite;
        }
        
        @keyframes rainbowFloat {
            0% {
                transform: translateY(-20px) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 0.8;
            }
            80% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(100dvh) translateX(50px) scale(1.2);
                opacity: 0;
            }
        }
        
        /* Ëôπ„ÅÆ„Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà */
        .rainbow-sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: rainbowTwinkle 3s infinite;
        }
        
        @keyframes rainbowTwinkle {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.5);
            }
        }
        
        /* ========== Top HUD ========== */
        #top-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: clamp(10px, 3vw, 16px);
            z-index: 20;
            pointer-events: none;
        }

        #hud-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            pointer-events: none;
        }

        #username-display {
            position: relative;
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            font-weight: 900;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(40, 40, 40, 0.95) 100%);
            padding: clamp(10px, 2.2vw, 16px) clamp(16px, 3.8vw, 28px);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            text-shadow: 
                0 0 15px rgba(255, 215, 0, 1),
                0 0 30px rgba(255, 215, 0, 0.5),
                0 3px 8px rgba(0, 0, 0, 0.8);
            z-index: 20;
            border: 3px solid #FFD700;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.6),
                0 8px 30px rgba(0, 0, 0, 0.4),
                inset 0 2px 10px rgba(255, 215, 0, 0.15);
            letter-spacing: 2px;
            font-family: 'Arial Black', 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
            max-width: 48vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: auto;
        }
        
        #username-display:hover {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(50, 50, 50, 1) 100%);
            transform: scale(1.05);
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.8),
                0 10px 35px rgba(0, 0, 0, 0.5),
                inset 0 2px 15px rgba(255, 215, 0, 0.2);
        }
        
        #username-text {
            cursor: pointer;
        }
        
        #settings-btn {
            position: fixed;
            top: 80px;
            left: 20px;
            background: transparent;
            border: none;
            width: 50px;
            height: 50px;
            font-size: 32px;
            cursor: pointer;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        #settings-btn:hover {
            transform: scale(1.2) rotate(45deg);
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
        }
        
        #settings-btn:active {
            transform: scale(1.0) rotate(90deg);
        }
        
        #rank-box {
            position: relative;
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            font-weight: 900;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(40, 40, 40, 0.95) 100%);
            padding: clamp(10px, 2.2vw, 16px) clamp(16px, 3.8vw, 28px);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            text-shadow: 
                0 0 15px rgba(255, 215, 0, 1),
                0 0 30px rgba(255, 215, 0, 0.5),
                0 3px 8px rgba(0, 0, 0, 0.8);
            border: 3px solid #FFD700;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.6),
                0 8px 30px rgba(0, 0, 0, 0.4),
                inset 0 2px 10px rgba(255, 215, 0, 0.15);
            letter-spacing: 2px;
            font-family: 'Arial Black', 'M PLUS Rounded 1c', sans-serif;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 48vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #rank-box:hover {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(50, 50, 50, 1) 100%);
            transform: scale(1.05);
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.8),
                0 10px 35px rgba(0, 0, 0, 0.5),
                inset 0 2px 15px rgba(255, 215, 0, 0.2);
        }

        #rank-display {
            color: #FFD700;
        }

        #currency-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        #diamond-counter {
            position: relative;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 14px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        
        #star-counter {
            position: relative;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 14px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        
        #character-area {
            position: relative;
            height: 50vh;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            padding-top: 5vh;
        }
        
        #character {
            font-size: 180px;
            cursor: pointer;
            transition: transform 0.1s ease;
            user-select: none;
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.3));
            animation: float 3s ease-in-out infinite;
            z-index: 5;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        #character.jumping {
            animation: jump 0.6s ease;
        }
        
        @keyframes jump {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-50px); }
        }
        
        .collectible-star {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            user-select: none;
            /* È£æ„Çä„Çà„ÇäÂøÖ„Åö‰∏ä„Å´Âá∫„Åô */
            z-index: 100;
            animation: starFloat 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            touch-action: manipulation;
        }
        
        @keyframes starFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .collectible-star.collected {
            animation: starCollect 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes starCollect {
            0% { 
                transform: scale(1);
                opacity: 1;
            }
            100% { 
                transform: scale(2) translateY(-50px);
                opacity: 0;
            }
        }
        
        /* „Éú„Éº„Éä„ÇπÊúà */
        .bonus-moon {
            position: absolute;
            font-size: 60px;
            cursor: pointer;
            z-index: 100;
            animation: moonSlide 8s linear;
            filter: drop-shadow(0 0 15px rgba(255, 255, 150, 0.8));
            transition: transform 0.2s ease;
            user-select: none;
        }
        
        @keyframes moonSlide {
            0% {
                left: -100px;
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                left: calc(100% + 100px);
                opacity: 0;
            }
        }
        
        .bonus-moon.collected {
            animation: moonCollect 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes moonCollect {
            0% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            100% { 
                transform: scale(3) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* È£æ„Çä„Ç®„É™„Ç¢ */
        #placement-area {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            pointer-events: none;
            /* „Ç≤„Éº„É†ÂÜÖ„Ç®„Éï„Çß„ÇØ„Éà„Çà„Çä‰∏ã„ÄÅUI„Çà„Çä‰∏ä„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´ */
            z-index: 8;
        }
        
        .placeable-decor {
            position: absolute;
            font-size: 80px;
            filter: drop-shadow(0 0 14px rgba(255,255,255,0.18));
            opacity: 0.95;
            cursor: move;
            pointer-events: auto;
            user-select: none;
            touch-action: none;
            transition: transform 0.1s ease;
            /* Êòü(collectible-star)„Çà„Çä‰∏ã */
            z-index: 10;
            /* üåö„Å®ÂÆåÂÖ®„Å´Âêå„Åò„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
            animation: float 3s ease-in-out infinite;
        }
        
        .placeable-decor.dragging {
            transform: scale(1.2);
            filter: drop-shadow(0 0 20px rgba(255,215,0,0.5));
            /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„Åß„ÇÇÊòü„Çà„Çä‰∏ä„Å´Êù•„Å™„ÅÑ */
            z-index: 15;
            /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢ */
            animation: none;
            pointer-events: auto;
        }
        
        .decor-slots-ui {
            display: flex;
            gap: 10px;
            margin: 10px 0 12px;
            flex-wrap: wrap;
        }
        
        .decor-slot-btn {
            padding: 10px 12px;
            border-radius: 14px;
            border: 2px solid rgba(255,215,0,0.5);
            background: rgba(0,0,0,0.28);
            color: #fff;
            font-size: 16px;
            min-width: 100px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        .decor-slot-btn.active {
            border-color: rgba(255,215,0,0.9);
            box-shadow: 0 0 18px rgba(255,215,0,0.35);
            transform: scale(1.05);
            background: rgba(255,215,0,0.15);
        }
        
        .decor-slot-btn:hover {
            border-color: rgba(255,215,0,0.7);
            transform: scale(1.03);
        }
        
        .decor-items-ui {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .decor-item-btn {
            padding: 10px 12px;
            border-radius: 14px;
            border: 2px solid rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .decor-item-btn:hover {
            transform: scale(1.15);
            border-color: rgba(255,215,0,0.5);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        
        .decor-item-btn:active {
            transform: scale(0.95);
        }
        
        .small-note {
            opacity: 0.7;
            font-size: 12px;
            margin-top: 8px;
        }
        
        #speech-bubble {
            position: absolute;
            bottom: -15%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px 25px;
            border-radius: 20px;
            min-width: 200px;
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 15;
        }
        
        #speech-bubble::before {
            content: '';
            position: absolute;
            left: 50%;
            top: -15px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 15px 15px 15px;
            border-color: transparent transparent white transparent;
        }
        
        #speech-bubble.show {
            opacity: 1;
        }
        
        #speech-text {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }
        
        #interaction-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        #status-info {
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.8;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
        }
        
        #button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .action-button {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .action-button:active {
            transform: scale(0.95);
        }
        
        .action-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #pixiv-btn {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(40, 40, 60, 0.95) 100%);
            border: 2px solid #667eea;
            box-shadow: 
                0 0 20px rgba(102, 126, 234, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 8px rgba(102, 126, 234, 0.15);
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.8);
        }
        
        #pixiv-btn:hover {
            box-shadow: 
                0 0 30px rgba(102, 126, 234, 0.6),
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 10px rgba(102, 126, 234, 0.25);
            border-color: #8099ff;
        }
        
        #mission-btn {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(40, 60, 60, 0.95) 100%);
            border: 2px solid #43e97b;
            box-shadow: 
                0 0 20px rgba(67, 233, 123, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 8px rgba(67, 233, 123, 0.15);
            text-shadow: 0 0 10px rgba(67, 233, 123, 0.8);
        }
        
        #mission-btn:hover {
            box-shadow: 
                0 0 30px rgba(67, 233, 123, 0.6),
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 10px rgba(67, 233, 123, 0.25);
            border-color: #5fffb0;
        }
        
        #gacha-btn {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(60, 40, 60, 0.95) 100%);
            border: 2px solid #f093fb;
            box-shadow: 
                0 0 20px rgba(240, 147, 251, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 8px rgba(240, 147, 251, 0.15);
            text-shadow: 0 0 10px rgba(240, 147, 251, 0.8);
        }
        
        #gacha-btn:hover {
            box-shadow: 
                0 0 30px rgba(240, 147, 251, 0.6),
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 10px rgba(240, 147, 251, 0.25);
            border-color: #ffb3ff;
        }
        
        #closet-btn {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(40, 50, 60, 0.95) 100%);
            border: 2px solid #4facfe;
            box-shadow: 
                0 0 20px rgba(79, 172, 254, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 8px rgba(79, 172, 254, 0.15);
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.8);
        }
        
        #closet-btn:hover {
            box-shadow: 
                0 0 30px rgba(79, 172, 254, 0.6),
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 10px rgba(79, 172, 254, 0.25);
            border-color: #70d0ff;
        }
        
        /* „É©„É≥„ÇØÁâπÂÖ∏„É¢„Éº„ÉÄ„É´ */
        #rank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        #rank-modal.show {
            display: flex;
        }
        
        #rank-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #FFD700;
        }
        
        #rank-modal-title {
            color: #FFD700;
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .reward-section {
            margin: 20px 0;
        }
        
        .reward-title {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .reward-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .reward-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .reward-item:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            transform: scale(1.05);
        }
        
        .reward-item.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .reward-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .reward-item.locked:hover {
            transform: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .reward-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .reward-name {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .reward-unlock {
            color: #FFD700;
            font-size: 12px;
        }
        
        .reward-locked {
            color: #999;
            font-size: 12px;
        }
        
        #close-modal-btn {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #close-modal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }
        
        /* „Ç¨„ÉÅ„É£„É¢„Éº„ÉÄ„É´ */
        #gacha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        #gacha-modal.show {
            display: flex;
        }
        
        #gacha-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 90%;
            /* „Çπ„Éû„Éõ„ÅßÂÖ®‰Ωì„ÅåË¶ã„Åà„Çã„Çà„ÅÜ„Å´Ë™øÊï¥ */
            max-height: 80vh;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #f093fb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
        }

        @media (max-width: 480px) {
            #gacha-content {
                padding: 20px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                max-height: 85vh;
            }
            #gacha-title { font-size: 26px; margin-bottom: 15px; }
            .gacha-type-btn { 
                padding: 15px; 
                font-size: 16px;
            }
            #gacha-result { min-height: 100px; }
            .gacha-result-icon { font-size: 80px; margin: 15px 0; }
            .gacha-result-text { font-size: 22px !important; }
            .gacha-result-type { font-size: 14px !important; }
            .gacha-rarity { font-size: 14px !important; padding: 6px 12px !important; }
            #close-gacha-btn { padding: 12px; font-size: 16px; }
        }
        
        #gacha-title {
            color: #f093fb;
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(240, 147, 251, 0.8);
        }
        
        #gacha-cost {
            color: #fff;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .gacha-type-btn {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .gacha-type-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(240, 147, 251, 0.6);
        }
        
        .gacha-type-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #gacha-pull-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        #gacha-pull-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 30px rgba(240, 147, 251, 0.6);
        }
        
        #gacha-pull-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #gacha-result {
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* ÁµêÊûú„ÅåË¶ã„Åà„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´ */
            flex: 0 1 auto;
            margin-bottom: 10px;
        }
        
        .gacha-result-icon {
            font-size: 100px;
            margin: 20px 0;
            animation: gachaAppear 0.5s ease;
        }
        
        @keyframes gachaAppear {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .falling-item {
            position: absolute;
            top: -50px;
            animation: itemFall linear infinite;
            pointer-events: none;
            opacity: 0.9;
        }
        
        @keyframes itemFall {
            0% {
                top: -50px;
                transform: translateX(0) rotate(0deg);
            }
            100% {
                top: 110%;
                transform: translateX(30px) rotate(360deg);
            }
        }
        
        .rising-item {
            position: absolute;
            bottom: -50px;
            animation: itemRise linear infinite;
            pointer-events: none;
            opacity: 0.9;
        }
        
        @keyframes itemRise {
            0% {
                bottom: -50px;
                transform: translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.9;
            }
            90% {
                opacity: 0.9;
            }
            100% {
                bottom: 110%;
                transform: translateX(-20px) rotate(-360deg);
                opacity: 0;
            }
        }
        
        .gacha-result-text {
            color: #fff;
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .gacha-result-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }
        
        .gacha-result-type {
            color: #ffd700;
            font-size: 16px;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .gacha-rarity {
            font-size: 18px;
            font-weight: 900;
            padding: 8px 20px;
            border-radius: 15px;
        }
        
        .rarity-common {
            background: linear-gradient(135deg, #808080 0%, #606060 100%);
            color: white;
        }
        
        .rarity-rare {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .rarity-sr {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .rarity-ssr {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        #close-gacha-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            flex: 0 0 auto;
        }
        
        /* ÁùÄ„ÅõÊõø„Åà„É¢„Éº„ÉÄ„É´ */
        #closet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        #closet-modal.show {
            display: flex;
        }
        
        #closet-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #4facfe;
        }
        
        #closet-title {
            color: #4facfe;
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.8);
        }
        
        #close-closet-btn {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
        }
        
        /* „É¶„Éº„Ç∂„Éº„Éç„Éº„É†ÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ */
        #username-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        #username-modal.show {
            display: flex;
        }
        
        #username-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #4facfe;
            text-align: center;
        }
        
        #username-modal-title {
            color: #4facfe;
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.8);
        }
        
        #username-input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            border: 2px solid #4facfe;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            margin-bottom: 10px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        
        #username-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        #username-char-count {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        #username-save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        #username-save-btn:hover {
            transform: scale(1.05);
        }
        
        #username-cancel-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* „Éü„ÉÉ„Ç∑„Éß„É≥„É¢„Éº„ÉÄ„É´ */
        #mission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #mission-modal.show {
            display: flex;
        }
        
        #mission-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #mission-modal-title {
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }
        
        #mission-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mission-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 15px;
            color: white;
        }
        
        .mission-item.completed {
            background: rgba(100, 255, 100, 0.3);
        }
        
        .mission-item.daily {
            background: linear-gradient(135deg, rgba(255, 200, 100, 0.4) 0%, rgba(255, 150, 50, 0.4) 100%);
            border: 2px solid rgba(255, 200, 100, 0.6);
        }
        
        .mission-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .mission-progress {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .mission-reward {
            font-size: 16px;
            font-weight: 700;
            color: #ffeb3b;
        }
        
        .mission-claim-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .mission-claim-btn:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }
        
        #close-mission-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        #settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        #settings-modal.show {
            display: flex;
        }
        
        #settings-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #FFD700;
        }
        
        @media (max-width: 480px) {
            #settings-modal-content {
                padding: 20px;
                width: 95%;
            }
        }
        
        #settings-modal-title {
            color: #FFD700;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            text-align: center;
        }
        
        .settings-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .settings-section-title {
            color: #4facfe;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .volume-control label {
            color: white;
            min-width: 80px;
            font-size: 16px;
        }
        
        .volume-control input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
        }
        
        .volume-control span {
            color: #FFD700;
            min-width: 40px;
            text-align: right;
            font-weight: 700;
        }
        
        .save-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .save-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #export-save-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        #import-save-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        #save-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .save-note {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .serial-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        #serial-input {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            box-sizing: border-box;
        }
        
        #serial-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        #serial-input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        #serial-submit-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        #serial-submit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        #serial-submit-btn:active {
            transform: scale(0.95);
        }
        
        #serial-message {
            color: #FFD700;
            font-size: 13px;
            min-height: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        #serial-message.success {
            color: #43e97b;
        }
        
        #serial-message.error {
            color: #f5576c;
        }
        
        #close-settings-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }
    

/* v54 viewport fix (Android Chrome address bar + safe-area) */
html, body { height: 100%; }

/* Use dynamic viewport units when supported */
/* Ensure bottom UI never gets clipped by system bars */
#interaction-area{
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
}

/* If any element was positioned flush to bottom, give it breathing room */
#button-grid{
  margin-bottom: calc(env(safe-area-inset-bottom, 0px) + 6px);
}

/* v55 moon tweak */
#character {
  font-size: 150px;
}
#character-area {
  padding-top: 10vh;
}


/* v56 moon further down */
#character-area {
  padding-top: calc(10vh + 75px); /* move down roughly one moon radius */
}

</style>
</head>
<body class="night-bg">
    <div id="viewport"><div id="app">
    <div id="game-container">
        <div id="stars"></div>
        
        <button id="settings-btn">‚öôÔ∏è</button>
        
        <div id="top-ui">
            <div id="username-display">
                <span id="username-text">ÂêçÂâç„ÇíÂÖ•Âäõ</span>
            </div>

            <div id="hud-right">
                <div id="rank-box"><span id="rank-display">Rank 1</span></div>
                <div id="currency-container">
                    <div id="diamond-counter">üíé √ó 0</div>
                    <div id="star-counter">‚≠êÔ∏è √ó 0</div>
                </div>
            </div>
        </div>
        
        <div id="character-area">
            <div id="character">üåö</div>
            <div id="speech-bubble">
                <div id="speech-text"></div>
            </div>
        </div>
        
        <!-- È£æ„Çä„Ç®„É™„Ç¢ -->
        <div id="placement-area"></div>
        
        <div id="interaction-area">
            <div id="status-info">„Åä„Å®„Äú„Åµ„ÅØÁµµ„ÇíÊèè„ÅÑ„Å¶„ÅÑ„Çã‚Ä¶</div>
            <div id="button-grid">
                <button class="action-button" id="pixiv-btn">pixiv (‚≠êÔ∏è3)</button>
                <button class="action-button" id="mission-btn">„Éü„ÉÉ„Ç∑„Éß„É≥</button>
                <button class="action-button" id="gacha-btn">„Ç¨„ÉÅ„É£</button>
                <button class="action-button" id="closet-btn">ÁùÄ„ÅõÊõø„Åà</button>
            </div>
        </div>
    </div>
    
    <!-- „Ç¨„ÉÅ„É£„É¢„Éº„ÉÄ„É´ -->
    <div id="gacha-modal">
        <div id="gacha-content">
            <div id="gacha-title">„Åä„Å®„Äú„Åµ„Ç¨„ÉÅ„É£</div>
            <div style="display: flex; gap: 10px; margin: 20px 0;">
                <button id="gacha-pull-btn-star" class="gacha-type-btn">
                    <div>‚≠êÔ∏è„Ç¨„ÉÅ„É£</div>
                    <div style="font-size: 14px;">‚≠êÔ∏è10ÂÄã</div>
                </button>
                <button id="gacha-pull-btn-diamond" class="gacha-type-btn">
                    <div style="font-size: 12px; color: #ffd700; font-weight: 700; margin-bottom: 2px;">SSRÁ¢∫ÂÆö</div>
                    <div>üíé„Ç¨„ÉÅ„É£</div>
                    <div style="font-size: 14px;">üíé1ÂÄã</div>
                </button>
            </div>
            <div id="gacha-result"></div>
            <button id="close-gacha-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- ÁùÄ„ÅõÊõø„Åà„É¢„Éº„ÉÄ„É´ -->
    <div id="closet-modal">
        <div id="closet-content">
            <div id="closet-title">üëî ÁùÄ„ÅõÊõø„Åà</div>
            
            <div class="reward-section">
                <div class="reward-title">üé® „Ç≠„É£„É©„ÇØ„Çø„Éº</div>
                <div class="reward-grid" id="closet-characters"></div>
            </div>
            
            <div class="reward-section">
                <div class="reward-title">üåÖ ËÉåÊôØ</div>
                <div class="reward-grid" id="closet-backgrounds"></div>
            </div>
            
            <div class="reward-section">
                <div class="reward-title">üéÄ È£æ„ÇäË®≠ÁΩÆ</div>
                <div class="decor-slots-ui">
                    <button class="decor-slot-btn active" data-slot="0">„Çπ„É≠„ÉÉ„Éà1</button>
                    <button class="decor-slot-btn" data-slot="1">„Çπ„É≠„ÉÉ„Éà2</button>
                    <button class="decor-slot-btn" data-slot="2">„Çπ„É≠„ÉÉ„Éà3</button>
                </div>
                <div class="decor-items-ui" id="closet-decors"></div>
                <div class="small-note">‚ÄªÁîªÈù¢‰∏ä„ÅßÈ£æ„Çä„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶Ëá™Áî±„Å´ÈÖçÁΩÆ„Åß„Åç„Åæ„Åô</div>
            </div>
            
            <button id="close-closet-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- „É¶„Éº„Ç∂„Éº„Éç„Éº„É†ÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div id="username-modal">
        <div id="username-modal-content">
            <div id="username-modal-title">„É¶„Éº„Ç∂„Éº„Éç„Éº„É†Ë®≠ÂÆö</div>
            <input type="text" id="username-input" maxlength="6" placeholder="ÂêçÂâç„ÇíÂÖ•ÂäõÔºà6ÊñáÂ≠ó„Åæ„ÅßÔºâ">
            <div id="username-char-count">0 / 6</div>
            <button id="username-save-btn">‰øùÂ≠ò</button>
            <button id="username-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
    
    <!-- „É©„É≥„ÇØÁâπÂÖ∏„É¢„Éº„ÉÄ„É´ -->
    <div id="rank-modal">
        <div id="rank-modal-content">
            <div id="rank-modal-title">„É©„É≥„ÇØÁâπÂÖ∏</div>
            
            <div class="reward-section">
                <div class="reward-title">üé® „Ç≠„É£„É©„ÇØ„Çø„ÉºÂ§âÊõ¥</div>
                <div class="reward-grid">
                    <div class="reward-item active" data-type="character" data-value="üåö" data-rank="1">
                        <div class="reward-icon">üåö</div>
                        <div class="reward-name">„Åä„Å®„Äú„Åµ</div>
                        <div class="reward-unlock">„Éá„Éï„Ç©„É´„Éà</div>
                    </div>
                    <div class="reward-item locked" data-type="character" data-value="üêµ" data-rank="5">
                        <div class="reward-icon">üêµ</div>
                        <div class="reward-name">„É¢„É≥„Ç≠„Éº</div>
                        <div class="reward-locked">Rank 5„ÅßËß£Á¶Å</div>
                    </div>
                    <div class="reward-item locked" data-type="character" data-value="ü§°" data-rank="10">
                        <div class="reward-icon">ü§°</div>
                        <div class="reward-name">„Éî„Ç®„É≠</div>
                        <div class="reward-locked">Rank 10„ÅßËß£Á¶Å</div>
                    </div>
                    <div class="reward-item locked" data-type="character" data-value="üåù" data-rank="20">
                        <div class="reward-icon">üåù</div>
                        <div class="reward-name">„É†„Éº„É≥</div>
                        <div class="reward-locked">Rank 20„ÅßËß£Á¶Å</div>
                    </div>
                </div>
            </div>
            
            <div class="reward-section">
                <div class="reward-title">üåÖ ËÉåÊôØÂ§âÊõ¥</div>
                <div class="reward-grid">
                    <div class="reward-item active" data-type="background" data-value="night" data-rank="1">
                        <div class="reward-icon">üåô</div>
                        <div class="reward-name">Â§úÁ©∫</div>
                        <div class="reward-unlock">„Éá„Éï„Ç©„É´„Éà</div>
                    </div>
                    <div class="reward-item locked" data-type="background" data-value="city" data-rank="15">
                        <div class="reward-icon">üåÜ</div>
                        <div class="reward-name">Â§ïÊöÆ„Çå</div>
                        <div class="reward-locked">Rank 15„ÅßËß£Á¶Å</div>
                    </div>
                    <div class="reward-item locked" data-type="background" data-value="rainbow" data-rank="20">
                        <div class="reward-icon">üåà</div>
                        <div class="reward-name">Ëôπ</div>
                        <div class="reward-locked">Rank 20„ÅßËß£Á¶Å</div>
                    </div>
                </div>
            </div>
            
            <button id="close-modal-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- „Éü„ÉÉ„Ç∑„Éß„É≥„É¢„Éº„ÉÄ„É´ -->
    <div id="mission-modal">
        <div id="mission-modal-content">
            <div id="mission-modal-title">„Éü„ÉÉ„Ç∑„Éß„É≥</div>
            <div id="mission-list"></div>
            <button id="close-mission-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settings-modal">
        <div id="settings-modal-content">
            <div id="settings-modal-title">‚öôÔ∏è Ë®≠ÂÆö</div>
            
            <div class="settings-section">
                <div class="settings-section-title">üîä Èü≥ÈáèË™øÊï¥</div>
                <div class="volume-control">
                    <label>BGM</label>
                    <input type="range" id="bgm-volume" min="0" max="100" value="15">
                    <span id="bgm-volume-text">15%</span>
                </div>
                <div class="volume-control">
                    <label>ÂäπÊûúÈü≥</label>
                    <input type="range" id="se-volume" min="0" max="100" value="100">
                    <span id="se-volume-text">100%</span>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">üíæ „Çª„Éº„Éñ„Éá„Éº„Çø</div>
                <div class="save-buttons">
                    <button id="export-save-btn">üì§ Êõ∏„ÅçÂá∫„Åô</button>
                    <button id="import-save-btn">üì• Âèñ„ÇäËæº„ÇÄ</button>
                </div>
                <textarea id="save-textarea" placeholder="„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                <div class="save-note">‚Äª „Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÊõ∏„ÅçÂá∫„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åä„Åë„Å∞„ÄÅ„Ç≤„Éº„É†„Éï„Ç°„Ç§„É´„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇÂºï„ÅçÁ∂ô„Åí„Åæ„Åô</div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">üéÅ „Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ</div>
                <div class="serial-input-container">
                    <input type="text" id="serial-input" placeholder="„Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ">
                    <button id="serial-submit-btn">ÈÅ©Áî®</button>
                </div>
                <div id="serial-message"></div>
            </div>
            
            <button id="close-settings-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- BGM -->
    <audio id="bgm" loop>
        <source src="orb2.mp3" type="audio/mpeg">
    </audio>

    <script>
        // BGMÂà∂Âæ°
        const bgm = document.getElementById('bgm');

        // iOS/Android„ÅßÈü≥Èáè„Çπ„É©„Ç§„ÉÄ„Éº„ÅåÁ¢∫ÂÆü„Å´Âäπ„Åè„Çà„ÅÜ„Å´„ÄÅWebAudio„ÅÆGain„ÅßÂà∂Âæ°„Åô„Çã
        // ÔºàHTMLAudioElement.volume „ÅØÁí∞Â¢É„Å´„Çà„Å£„Å¶ÂèçÊò†„Åï„Çå„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„ÇãÔºâ
        let bgmContext = null;
        let bgmGain = null;

        let seContext = null;
        let seMasterGain = null;

        function initAudioGraph() {
            // BGM
            if (!bgmContext && bgm) {
                bgmContext = new (window.AudioContext || window.webkitAudioContext)();
                bgmGain = bgmContext.createGain();

                const saved = localStorage.getItem('bgmVolume');
                const v = (saved !== null ? parseFloat(saved) : 15) / 100;
                bgmGain.gain.value = isFinite(v) ? v : 0.15;

                const src = bgmContext.createMediaElementSource(bgm);
                src.connect(bgmGain);
                bgmGain.connect(bgmContext.destination);

                // ÂÆüÈöõ„ÅÆÈü≥Èáè„ÅØ bgmGain „ÅßË™øÊï¥„Åô„Çã„ÅÆ„Åß„ÄÅË¶ÅÁ¥†ÂÅ¥„ÅØÊúÄÂ§ß„Å´
                bgm.volume = 1;
            }

            // ÂäπÊûúÈü≥ÔºàBGM„Å®Âêå„ÅòContext„Çí‰Ωø„ÅÜÔºâ
            if (!seContext) {
                seContext = bgmContext || new (window.AudioContext || window.webkitAudioContext)();
                seMasterGain = seContext.createGain();

                const saved = localStorage.getItem('seVolume');
                const v = (saved !== null ? parseFloat(saved) : 100) / 100;
                seMasterGain.gain.value = isFinite(v) ? v : 1.0;

                seMasterGain.connect(seContext.destination);
            }
        }

        function resumeAudio() {
            initAudioGraph();
            [bgmContext, seContext].forEach(ctx => {
                if (ctx && ctx.state === 'suspended') ctx.resume().catch(() => {});
            });
        }

        
        // „É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´BGMÂÜçÁîü„ÇíÈñãÂßã
        let bgmStarted = false;
        function startBGM() {
            // „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅßAudioContext„ÇíËµ∑Âãï
            resumeAudio();

            if (!bgm) return;

            // „Åô„Åß„Å´ÈñãÂßãÊ∏à„Åø„Åß„ÇÇ„ÄÅimportÁ≠â„ÅßÊ≠¢„Åæ„Å£„Å¶„ÅÑ„Åü„ÇâÂøÖ„ÅöÂÜçÈñã„Åô„Çã
            if (bgm.paused || bgm.ended) {
                bgm.play().catch(() => {});
            }
            bgmStarted = true;
        }

// ÊúÄÂàù„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßBGMÈñãÂßã
        document.addEventListener('click', startBGM, { once: true });
        document.addEventListener('touchstart', startBGM, { once: true });
        
        // ÂäπÊûúÈü≥Èü≥Èáè
        let seVolume = 1.0;
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const bgmVolumeSlider = document.getElementById('bgm-volume');
        const bgmVolumeText = document.getElementById('bgm-volume-text');
        const seVolumeSlider = document.getElementById('se-volume');
        const seVolumeText = document.getElementById('se-volume-text');
        const exportSaveBtn = document.getElementById('export-save-btn');
        const importSaveBtn = document.getElementById('import-save-btn');
        const saveTextarea = document.getElementById('save-textarea');
        
        // ‰øùÂ≠ò„Åï„Çå„ÅüÈü≥ÈáèË®≠ÂÆö„ÇíÂÖà„Å´Ë™≠„ÅøËæº„ÇÄ
        const savedBgmVolume = localStorage.getItem('bgmVolume');
        if (savedBgmVolume !== null) {
            bgmVolumeSlider.value = savedBgmVolume;
            // bgm.volume „ÅØÁí∞Â¢ÉÂ∑Æ„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅÂÆüÈü≥Èáè„ÅØWebAudio(Gain)„ÅßÂà∂Âæ°
            bgm.volume = 1;
            bgmVolumeText.textContent = savedBgmVolume + '%';
        } else {
            // ÂàùÂõû„ÅØ„Éá„Éï„Ç©„É´„Éà15%
            bgm.volume = 1;
            bgmVolumeSlider.value = 15;
            bgmVolumeText.textContent = '15%';
        }
        
        const savedSeVolume = localStorage.getItem('seVolume');
        if (savedSeVolume !== null) {
            seVolumeSlider.value = savedSeVolume;
            seVolume = savedSeVolume / 100;
            seVolumeText.textContent = savedSeVolume + '%';
        }
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
        });
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });
        
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        });
        
        // BGMÈü≥ÈáèË™øÊï¥
        bgmVolumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            if (bgmGain) {
                bgmGain.gain.value = volume;
            } else if (bgm) {
                bgm.volume = volume;
            }
            bgmVolumeText.textContent = e.target.value + '%';
            localStorage.setItem('bgmVolume', e.target.value);
        });
        
        bgmVolumeSlider.addEventListener('change', (e) => {
            const volume = e.target.value / 100;
            if (bgmGain) {
                bgmGain.gain.value = volume;
            } else if (bgm) {
                bgm.volume = volume;
            }
            bgmVolumeText.textContent = e.target.value + '%';
            localStorage.setItem('bgmVolume', e.target.value);
        });
        
        // ÂäπÊûúÈü≥Èü≥ÈáèË™øÊï¥
        seVolumeSlider.addEventListener('input', (e) => {
            seVolume = e.target.value / 100;
            if (seMasterGain) seMasterGain.gain.value = seVolume;
            seVolumeText.textContent = e.target.value + '%';
            localStorage.setItem('seVolume', e.target.value);
        });
        
        seVolumeSlider.addEventListener('change', (e) => {
            seVolume = e.target.value / 100;
            if (seMasterGain) seMasterGain.gain.value = seVolume;
            seVolumeText.textContent = e.target.value + '%';
            localStorage.setItem('seVolume', e.target.value);
        });
        
        // „Çª„Éº„Éñ„Éá„Éº„ÇøÊõ∏„ÅçÂá∫„Åó
        exportSaveBtn.addEventListener('click', () => {
            const saveData = localStorage.getItem('otofuGameData') || '';
            saveTextarea.value = saveData;
            saveTextarea.select();
        });
        
        // „Çª„Éº„Éñ„Éá„Éº„ÇøÂèñ„ÇäËæº„Åø
        importSaveBtn.addEventListener('click', () => {
            const data = saveTextarea.value.trim();
            if (!data) {
                alert('„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            try {
                JSON.parse(data); // „Éá„Éº„Çø„ÅåÂ£ä„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                localStorage.setItem('otofuGameData', data);
                alert('„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂèñ„ÇäËæº„Åø„Åæ„Åó„Åü„ÄÇÂèçÊò†„Åó„Åæ„Åô„ÄÇ');
                // Âèñ„ÇäËæº„ÅøÂæå„ÅØ„É™„É≠„Éº„Éâ„Åõ„Åö„ÄÅ„Åù„ÅÆÂ†¥„ÅßÁä∂ÊÖã„ÇíË™≠„ÅøËæº„ÅøÁõ¥„Åó„Å¶UI„ÇíÊõ¥Êñ∞Ôºà„É¢„Éê„Ç§„É´„ÅÆËá™ÂãïÂÜçÁîüÂà∂Èôê„ÅßBGM„ÅåÊ≠¢„Åæ„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
                try {
                    loadGameData();
                    refreshUIFromState();
                } catch (e) {
                    // ‰∏á‰∏ÄÂ§±Êïó„Åó„Åü„ÇâÂæìÊù•„Å©„Åä„Çä„É™„É≠„Éº„Éâ
                    location.reload();
                }
                // Èü≥Â£∞„ÇíÁ¢∫ÂÆü„Å´ÂÜçÈñã
                startBGM();

            } catch (e) {
                alert('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        });
        
        // „Ç≤„Éº„É†Áä∂ÊÖã
        let lastInteraction = Date.now();
        let isAnimating = false;
        let startDate = null;
        let collectedStars = 10;
        let maxStars = 999;
        let lastStarRegenTime = Date.now();
        let collectibleStarsArray = [];
        let bonusMoonActive = false;
        let lastBonusMoonTime = 0;
        
        // „ÉÄ„Ç§„É§„Ç∑„Çπ„ÉÜ„É†
        let collectedDiamonds = 0;
        let maxDiamonds = 99;
        let diamondSpawnedToday = false;
        let lastDiamondSpawnDate = null;
        
        // „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÂà§ÂÆö
        function isTestMode() { return username === '„ÉÜ„Çπ„Éà'; }
        let lastCommandTime = 0;
        let commandCooldown = 500;
        
        // ÁµåÈ®ìÂÄ§„Éª„É©„É≥„ÇØ„Ç∑„Çπ„ÉÜ„É†
        let experience = 0;
        let rank = 1;
        const maxRank = 100;
        
        // „É©„É≥„ÇØÁâπÂÖ∏Ë®≠ÂÆö
        let currentCharacter = 'üåö';
        let currentBackground = 'night';
        let username = 'ÂêçÂâç„ÇíÂÖ•Âäõ';
        
        // „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÔºàÁç≤Âæó„Åó„Åü„Ç¢„Ç§„ÉÜ„É†Ôºâ
        let unlockedCharacters = ['üåö']; // „Éá„Éï„Ç©„É´„Éà„Åßüåö„ÅØÊâÄÊåÅ
        let unlockedBackgrounds = ['night']; // „Éá„Éï„Ç©„É´„Éà„ÅßÂ§úÁ©∫„ÅØÊâÄÊåÅ
        let ownedDecor = {}; // È£æ„Çä„Ç§„É≥„Éô„É≥„Éà„É™ÔºàÂõ∫ÊúâÔºâ
        let equippedDecor = [null, null, null]; // Ë£ÖÂÇô‰∏≠„ÅÆÈ£æ„ÇäÔºà3„Å§„Åæ„ÅßÔºâ
        let decorPlacements = [null, null, null]; // È£æ„Çä„ÅÆ‰ΩçÁΩÆÊÉÖÂ†± {x:0..1, y:0..1}
        
        // „Éü„ÉÉ„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†
        let missionProgress = {
            talkCount: 0,
            pixivCount: 0
        };
        let claimedMissions = [];
        
        // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†
        let dailyMissions = [];
        let dailyMissionProgress = {
            dailyTalkCount: 0,
            dailyPixivCount: 0,
            openedGacha: false,
            changedDecor: false
        };
        let lastDailyResetDate = null;
        
        // „Ç¨„ÉÅ„É£„Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ©
        const gachaCharacters = [
            { emoji: 'üê∏', name: '„Ç´„Ç®„É´', rarity: 'common' },
            { emoji: 'ü¶≠', name: '„Ç¢„Ç∂„É©„Ç∑', rarity: 'common' },
            { emoji: 'üí©', name: '„ÅÜ„Çì„Å°', rarity: 'common' },
            { emoji: 'üëÅÔ∏è', name: '„Ç¢„Ç§', rarity: 'rare' },
            { emoji: 'ü¶ß', name: '„Ç™„É©„É≥„Ç¶„Éº„Çø„É≥', rarity: 'rare' },
            { emoji: 'ü•∫', name: '„Å¥„Åà„Çì', rarity: 'rare' },
            { emoji: 'üëπ', name: '„Ç™„Éã', rarity: 'sr' },
            { emoji: 'üëΩ', name: '„Ç®„Ç§„É™„Ç¢„É≥', rarity: 'sr' },
            { emoji: 'üê≤', name: '„Éâ„É©„Ç¥„É≥', rarity: 'ssr' },
            { emoji: 'üåû', name: '„Çµ„É≥', rarity: 'ssr' }
        ];
        
        const gachaBackgrounds = [
            { id: 'snow', name: 'Èõ™ÊôØËâ≤', emoji: '‚ùÑÔ∏è', rarity: 'common' },
            { id: 'sakura', name: 'Ê°ú‰∏¶Êú®', emoji: 'üå∏', rarity: 'rare' },
            { id: 'forest', name: 'Ê£Æ', emoji: 'üå≤', rarity: 'rare' },
            { id: 'lava', name: 'Ê∫∂Â≤©', emoji: 'üî•', rarity: 'sr' },
            { id: 'music', name: 'Èü≥Ê•Ω', emoji: 'üéπ', rarity: 'sr' },
            { id: 'dream', name: 'Â§¢', emoji: 'üõå', rarity: 'ssr' },
            { id: 'aurora', name: '„Ç™„Éº„É≠„É©', emoji: 'üåå', rarity: 'ssr' },
            { id: 'rain', name: 'Èõ®', emoji: 'üåßÔ∏è', rarity: 'ssr' },
            { id: 'earth', name: 'Âú∞ÁêÉ', emoji: 'üåè', rarity: 'ssr' },
            { id: 'toilet', name: '„Éà„Ç§„É¨', emoji: 'üöΩ', rarity: 'ssr' },
            { id: 'love', name: 'ÊÅã', emoji: 'üíï', rarity: 'ssr' }
        ];
        
        const gachaDecors = [
            { emoji: 'üéà', name: '„Åµ„Çè„Åµ„ÇèÈ¢®Ëàπ', rarity: 'common' },
            { emoji: 'üç¶', name: '„ÇΩ„Éï„Éà„ÇØ„É™„Éº„É†', rarity: 'common' },
            { emoji: 'üç°', name: '„Å†„Çì„Åî', rarity: 'common' },
            { emoji: '‚òïÔ∏è', name: '„Ç≥„Éº„Éí„Éº', rarity: 'common' },
            { emoji: 'üéÄ', name: '„É™„Éú„É≥', rarity: 'rare' },
            { emoji: 'üï∂Ô∏è', name: '„Çµ„É≥„Ç∞„É©„Çπ', rarity: 'rare' },
            { emoji: 'üé§', name: '„Éû„Ç§„ÇØ', rarity: 'rare' },
            { emoji: 'ü™¥', name: 'Ë¶≥ËëâÊ§çÁâ©', rarity: 'rare' },
            { emoji: 'üßÅ', name: '„Ç´„ÉÉ„Éó„Ç±„Éº„Ç≠', rarity: 'sr' },
            { emoji: 'üçì', name: '„ÅÑ„Å°„Åî', rarity: 'sr' },
            { emoji: 'üéÆ', name: '„Ç≤„Éº„É†', rarity: 'sr' },
            { emoji: 'üé©', name: '„Ç∑„É´„ÇØ„Éè„ÉÉ„Éà', rarity: 'sr' },
            { emoji: 'ü´ß', name: '„Åó„ÇÉ„Åº„ÇìÁéâ', rarity: 'ssr' },
            { emoji: 'üß∏', name: '„Åè„Åæ„Å¨„ÅÑ', rarity: 'ssr' }
        ];
        
        // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆöÁæ©
        const missions = [
            // Ë©±„Åó„Åã„Åë„Çã„Éü„ÉÉ„Ç∑„Éß„É≥
            { id: 'talk_5', name: '5ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 5, reward: 3, rewardType: 'star' },
            { id: 'talk_20', name: '20ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 20, reward: 5, rewardType: 'star' },
            { id: 'talk_50', name: '50ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 50, reward: 10, rewardType: 'star' },
            { id: 'talk_100', name: '100ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 100, reward: 15, rewardType: 'star' },
            { id: 'talk_200', name: '200ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 200, reward: 1, rewardType: 'diamond' },
            { id: 'talk_500', name: '500ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 500, reward: 2, rewardType: 'diamond' },
            { id: 'talk_1000', name: '1000ÂõûË©±„Åó„Åã„Åë„Çã', type: 'talk', target: 1000, reward: 3, rewardType: 'diamond' },
            
            // pixiv„Éü„ÉÉ„Ç∑„Éß„É≥
            { id: 'pixiv_3', name: 'pixiv„Çí3ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 3, reward: 3, rewardType: 'star' },
            { id: 'pixiv_10', name: 'pixiv„Çí10ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 10, reward: 5, rewardType: 'star' },
            { id: 'pixiv_30', name: 'pixiv„Çí30ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 30, reward: 10, rewardType: 'star' },
            { id: 'pixiv_50', name: 'pixiv„Çí50ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 50, reward: 15, rewardType: 'star' },
            { id: 'pixiv_100', name: 'pixiv„Çí100ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 100, reward: 1, rewardType: 'diamond' },
            { id: 'pixiv_200', name: 'pixiv„Çí200ÂõûË¶ã„Åõ„Çã', type: 'pixiv', target: 200, reward: 2, rewardType: 'diamond' },
            
            // „É©„É≥„ÇØ„Éü„ÉÉ„Ç∑„Éß„É≥
            { id: 'rank_5', name: 'Rank 5„Å´Âà∞ÈÅî', type: 'rank', target: 5, reward: 5, rewardType: 'star' },
            { id: 'rank_10', name: 'Rank 10„Å´Âà∞ÈÅî', type: 'rank', target: 10, reward: 10, rewardType: 'star' },
            { id: 'rank_20', name: 'Rank 20„Å´Âà∞ÈÅî', type: 'rank', target: 20, reward: 15, rewardType: 'star' },
            { id: 'rank_30', name: 'Rank 30„Å´Âà∞ÈÅî', type: 'rank', target: 30, reward: 20, rewardType: 'star' },
            { id: 'rank_40', name: 'Rank 40„Å´Âà∞ÈÅî', type: 'rank', target: 40, reward: 1, rewardType: 'diamond' },
            { id: 'rank_50', name: 'Rank 50„Å´Âà∞ÈÅî', type: 'rank', target: 50, reward: 1, rewardType: 'diamond' },
            { id: 'rank_60', name: 'Rank 60„Å´Âà∞ÈÅî', type: 'rank', target: 60, reward: 2, rewardType: 'diamond' },
            { id: 'rank_70', name: 'Rank 70„Å´Âà∞ÈÅî', type: 'rank', target: 70, reward: 2, rewardType: 'diamond' },
            { id: 'rank_80', name: 'Rank 80„Å´Âà∞ÈÅî', type: 'rank', target: 80, reward: 3, rewardType: 'diamond' },
            { id: 'rank_90', name: 'Rank 90„Å´Âà∞ÈÅî', type: 'rank', target: 90, reward: 3, rewardType: 'diamond' },
            { id: 'rank_100', name: 'Rank 100„Å´Âà∞ÈÅî', type: 'rank', target: 100, reward: 5, rewardType: 'diamond' }
        ];
        
        // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ÂÄôË£úÔºàÊòüÂ†±ÈÖ¨Ôºâ
        const dailyMissionTemplatesStar = [
            { type: 'dailyTalk', target: 5, name: '5Âõûüåö„Çí„Çø„ÉÉ„Éó„Åó„Çà„ÅÜ', reward: 2, rewardType: 'star' },
            { type: 'dailyTalk', target: 10, name: '10Âõûüåö„Çí„Çø„ÉÉ„Éó„Åó„Çà„ÅÜ', reward: 3, rewardType: 'star' },
            { type: 'dailyPixiv', target: 1, name: 'pixiv„Çí1ÂõûË¶ã„Çà„ÅÜ', reward: 2, rewardType: 'star' },
            { type: 'dailyPixiv', target: 3, name: 'pixiv„Çí3ÂõûË¶ã„Çà„ÅÜ', reward: 3, rewardType: 'star' },
            { type: 'openGacha', target: 1, name: '„Ç¨„ÉÅ„É£ÁîªÈù¢„ÇíÈñã„Åì„ÅÜ', reward: 2, rewardType: 'star' },
            { type: 'changeDecor', target: 1, name: 'È£æ„Çä„ÇíÂ§â„Åà„Çà„ÅÜ', reward: 2, rewardType: 'star' }
        ];
        
        // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ÂÄôË£úÔºà„ÉÄ„Ç§„É§Â†±ÈÖ¨Ôºâ
        const dailyMissionTemplatesDiamond = [
            { type: 'dailyTalk', target: 5, name: '5Âõûüåö„Çí„Çø„ÉÉ„Éó„Åó„Çà„ÅÜ', reward: 1, rewardType: 'diamond' },
            { type: 'dailyTalk', target: 10, name: '10Âõûüåö„Çí„Çø„ÉÉ„Éó„Åó„Çà„ÅÜ', reward: 1, rewardType: 'diamond' },
            { type: 'dailyPixiv', target: 1, name: 'pixiv„Çí1ÂõûË¶ã„Çà„ÅÜ', reward: 1, rewardType: 'diamond' },
            { type: 'dailyPixiv', target: 3, name: 'pixiv„Çí3ÂõûË¶ã„Çà„ÅÜ', reward: 1, rewardType: 'diamond' },
            { type: 'openGacha', target: 1, name: '„Ç¨„ÉÅ„É£ÁîªÈù¢„ÇíÈñã„Åì„ÅÜ', reward: 1, rewardType: 'diamond' },
            { type: 'changeDecor', target: 1, name: 'È£æ„Çä„ÇíÂ§â„Åà„Çà„ÅÜ', reward: 1, rewardType: 'diamond' }
        ];
        
        // DOMË¶ÅÁ¥†
        const gameContainer = document.getElementById('game-container');
        const character = document.getElementById('character');
        const characterArea = document.getElementById('character-area');
        const speechBubble = document.getElementById('speech-bubble');
        const speechText = document.getElementById('speech-text');
        const statusInfo = document.getElementById('status-info');
        const usernameDisplay = document.getElementById('username-display');
        const usernameText = document.getElementById('username-text');
        const rankDisplay = document.getElementById('rank-display');
        const rankModal = document.getElementById('rank-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const gachaModal = document.getElementById('gacha-modal');
        const gachaPullBtnStar = document.getElementById('gacha-pull-btn-star');
        const gachaPullBtnDiamond = document.getElementById('gacha-pull-btn-diamond');
        const gachaResult = document.getElementById('gacha-result');
        const closeGachaBtn = document.getElementById('close-gacha-btn');
        const closetModal = document.getElementById('closet-modal');
        const closeClosetBtn = document.getElementById('close-closet-btn');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const usernameCharCount = document.getElementById('username-char-count');
        const usernameSaveBtn = document.getElementById('username-save-btn');
        const usernameCancelBtn = document.getElementById('username-cancel-btn');
        const placementArea = document.getElementById('placement-area');
        const missionModal = document.getElementById('mission-modal');
        const closeMissionBtn = document.getElementById('close-mission-btn');
        const missionList = document.getElementById('mission-list');
        
        // ÊòüÁ©∫ÁîüÊàê
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }
        
        // ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„ÉàÁîüÊàê
        function generateBackgroundEffect(bgType) {
            // Êó¢Â≠ò„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà„Çí„ÇØ„É™„Ç¢
            starsContainer.innerHTML = '';
            
            switch(bgType) {
                case 'night':
                    // ÊòüÁ©∫„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 100; i++) {
                        const star = document.createElement('div');
                        star.className = 'star';
                        star.style.left = Math.random() * 100 + '%';
                        star.style.top = Math.random() * 100 + '%';
                        star.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(star);
                    }
                    break;
                    
                case 'rainbow':
                    // Ëôπ„ÅÆÂÖâ„ÅÆÁ≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„Éà
                    const rainbowColors = [
                        'rgba(255, 20, 147, 0.9)', // ÊøÉ„ÅÑ„Éî„É≥„ÇØ
                        'rgba(255, 69, 0, 0.9)',   // Ëµ§„Ç™„É¨„É≥„Ç∏
                        'rgba(255, 165, 0, 0.9)',  // „Ç™„É¨„É≥„Ç∏
                        'rgba(255, 215, 0, 0.9)',  // „Ç¥„Éº„É´„Éâ
                        'rgba(50, 205, 50, 0.9)',  // „É©„Ç§„É†„Ç∞„É™„Éº„É≥
                        'rgba(0, 191, 255, 0.9)',  // „Éá„Ç£„Éº„Éó„Çπ„Ç´„Ç§„Éñ„É´„Éº
                        'rgba(138, 43, 226, 0.9)', // „Éñ„É´„Éº„Éê„Ç§„Ç™„É¨„ÉÉ„Éà
                        'rgba(255, 0, 255, 0.9)',  // „Éû„Çº„É≥„Çø
                    ];
                    for (let i = 0; i < 70; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'rainbow-particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.background = rainbowColors[Math.floor(Math.random() * rainbowColors.length)];
                        particle.style.boxShadow = `0 0 15px ${rainbowColors[Math.floor(Math.random() * rainbowColors.length)]}`;
                        const duration = Math.random() * 5 + 4;
                        particle.style.animationDuration = duration + 's';
                        particle.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(particle);
                    }
                    // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 50; i++) {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'rainbow-sparkle';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        const color = rainbowColors[Math.floor(Math.random() * rainbowColors.length)];
                        sparkle.style.background = color;
                        sparkle.style.boxShadow = `0 0 10px ${color}`;
                        sparkle.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(sparkle);
                    }
                    break;
                    
                case 'dream':
                    // Â§¢„ÅÆÂÖâ„ÅÆÁ≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„ÉàÔºàÊüî„Çâ„Åã„ÅÑËâ≤Ôºâ
                    const dreamColors = [
                        'rgba(255, 107, 157, 0.8)', // „Éî„É≥„ÇØ
                        'rgba(255, 168, 180, 0.8)', // „Çµ„Éº„É¢„É≥„Éî„É≥„ÇØ
                        'rgba(255, 221, 204, 0.8)', // „Éî„Éº„ÉÅ
                        'rgba(255, 255, 221, 0.8)', // „Ç§„Ç®„É≠„Éº
                        'rgba(212, 255, 221, 0.8)', // „Éü„É≥„Éà„Ç∞„É™„Éº„É≥
                        'rgba(180, 244, 255, 0.8)', // „Çπ„Ç´„Ç§„Éñ„É´„Éº
                        'rgba(168, 157, 255, 0.8)', // „É©„Éô„É≥„ÉÄ„Éº
                    ];
                    for (let i = 0; i < 50; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'rainbow-particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.background = dreamColors[Math.floor(Math.random() * dreamColors.length)];
                        const duration = Math.random() * 5 + 4;
                        particle.style.animationDuration = duration + 's';
                        particle.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(particle);
                    }
                    // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 30; i++) {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'rainbow-sparkle';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        sparkle.style.background = dreamColors[Math.floor(Math.random() * dreamColors.length)];
                        sparkle.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(sparkle);
                    }
                    break;
                    
                case 'snow':
                    // Èõ™„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 50; i++) {
                        const snowflake = document.createElement('div');
                        snowflake.className = 'snowflake';
                        snowflake.style.left = Math.random() * 100 + '%';
                        snowflake.style.width = (Math.random() * 5 + 5) + 'px';
                        snowflake.style.height = snowflake.style.width;
                        const duration = Math.random() * 3 + 3;
                        snowflake.style.animationDuration = duration + 's';
                        // ÁîªÈù¢ÂÖ®‰Ωì„Å´ÂàÜÊï£„Åï„Åõ„Çã„Åü„ÇÅ„ÄÅË≤†„ÅÆÈÅÖÂª∂„ÅßÂàùÊúü‰ΩçÁΩÆ„ÇíË™øÊï¥
                        snowflake.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(snowflake);
                    }
                    // Ê∞¥Ëâ≤„ÅÆÈõ™„ÅÆÁµêÊô∂„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 15; i++) {
                        const crystal = document.createElement('div');
                        crystal.className = 'snowcrystal';
                        crystal.textContent = '‚ùÑ';
                        crystal.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 4 + 4;
                        crystal.style.animationDuration = duration + 's';
                        crystal.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(crystal);
                    }
                    break;
                    
                case 'forest':
                    // Ëëâ„Å£„Å±„Ç®„Éï„Çß„ÇØ„Éà
                    const leafColors = ['dark-green', 'medium-green', 'light-green'];
                    for (let i = 0; i < 30; i++) {
                        const leaf = document.createElement('div');
                        // „É©„É≥„ÉÄ„É†„Å´3Ëâ≤„Åã„ÇâÈÅ∏Êäû
                        const randomColor = leafColors[Math.floor(Math.random() * leafColors.length)];
                        leaf.className = 'leaf ' + randomColor;
                        leaf.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 4 + 4;
                        leaf.style.animationDuration = duration + 's';
                        // ÁîªÈù¢ÂÖ®‰Ωì„Å´ÂàÜÊï£„Åï„Åõ„Çã„Åü„ÇÅ„ÄÅË≤†„ÅÆÈÅÖÂª∂„ÅßÂàùÊúü‰ΩçÁΩÆ„ÇíË™øÊï¥
                        leaf.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(leaf);
                    }
                    break;
                    
                case 'rain':
                    // Èõ®„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 60; i++) {
                        const raindrop = document.createElement('div');
                        raindrop.className = 'raindrop';
                        raindrop.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 0.5 + 0.5;
                        raindrop.style.animationDuration = duration + 's';
                        raindrop.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(raindrop);
                    }
                    break;
                    
                case 'love':
                    // ÊÅã„ÅÆ„Éè„Éº„Éà„Ç®„Éï„Çß„ÇØ„Éà
                    const heartColors = ['pink-heart', 'red-heart'];
                    for (let i = 0; i < 40; i++) {
                        const heart = document.createElement('div');
                        const randomColor = heartColors[Math.floor(Math.random() * heartColors.length)];
                        heart.className = 'heart ' + randomColor;
                        heart.textContent = '‚ù§';
                        heart.style.left = Math.random() * 100 + '%';
                        heart.style.fontSize = (Math.random() * 20 + 20) + 'px';
                        const duration = Math.random() * 4 + 4;
                        heart.style.animationDuration = duration + 's';
                        heart.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(heart);
                    }
                    break;
                    
                case 'sakura':
                    // Ê°ú„ÅÆËä±„Å≥„Çâ„Ç®„Éï„Çß„ÇØ„ÉàÔºà3Ëâ≤Ôºâ
                    const petalColors = ['dark-pink', 'medium-pink', 'light-pink'];
                    for (let i = 0; i < 40; i++) {
                        const petal = document.createElement('div');
                        // „É©„É≥„ÉÄ„É†„Å´3Ëâ≤„Åã„ÇâÈÅ∏Êäû
                        const randomColor = petalColors[Math.floor(Math.random() * petalColors.length)];
                        petal.className = 'petal ' + randomColor;
                        petal.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 5 + 4;
                        petal.style.animationDuration = duration + 's';
                        petal.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(petal);
                    }
                    break;
                    
                case 'city':
                    // ÈÉΩ‰ºö„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 50; i++) {
                        const light = document.createElement('div');
                        light.className = 'city-light';
                        light.style.left = Math.random() * 100 + '%';
                        light.style.top = Math.random() * 100 + '%';
                        light.style.animationDelay = Math.random() * 2 + 's';
                        starsContainer.appendChild(light);
                    }
                    break;
                    
                case 'lava':
                    // Ê∫∂Â≤©„ÅÆÁÅ´Ëä±„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 40; i++) {
                        const spark = document.createElement('div');
                        spark.className = 'spark';
                        spark.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 3 + 2;
                        spark.style.animationDuration = duration + 's';
                        spark.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(spark);
                    }
                    // Èªí„ÅÑÁÖô„ÉªÁÅ∞„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 20; i++) {
                        const smoke = document.createElement('div');
                        smoke.className = 'lava-smoke';
                        smoke.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 4 + 3;
                        smoke.style.animationDuration = duration + 's';
                        smoke.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(smoke);
                    }
                    // Ê∫∂Â≤©„ÅÆÂ°ä„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 15; i++) {
                        const chunk = document.createElement('div');
                        chunk.className = 'lava-chunk';
                        chunk.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 3.5 + 2.5;
                        chunk.style.animationDuration = duration + 's';
                        chunk.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(chunk);
                    }
                    break;
                    
                case 'aurora':
                    // „Ç™„Éº„É≠„É©„ÅÆÂÖâ„ÅÆ„Ç´„Éº„ÉÜ„É≥
                    for (let i = 0; i < 5; i++) {
                        const wave = document.createElement('div');
                        wave.className = 'aurora-wave';
                        wave.style.animationDelay = (i * 2) + 's';
                        wave.style.left = (i * 25) + '%';
                        starsContainer.appendChild(wave);
                    }
                    // Êòü„ÇÇËøΩÂä†
                    for (let i = 0; i < 60; i++) {
                        const star = document.createElement('div');
                        star.className = 'star';
                        star.style.left = Math.random() * 100 + '%';
                        star.style.top = Math.random() * 100 + '%';
                        star.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(star);
                    }
                    break;
                    
                case 'earth':
                    // Âú∞ÁêÉ„ÅÆËëâ„Å£„Å±„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁ∑ëÂ§ö„ÇÅÔºâ
                    const earthLeafColors = [
                        'earth-blue', 
                        'earth-green', 'earth-green', 'earth-green', // Á∑ë„Çí3ÂÄç„Å´
                        'earth-teal', 'earth-teal' // ÈùíÁ∑ë„Çí2ÂÄç„Å´
                    ];
                    for (let i = 0; i < 30; i++) { // 25‚Üí30„Å´Â¢óÂä†
                        const leaf = document.createElement('div');
                        const randomColor = earthLeafColors[Math.floor(Math.random() * earthLeafColors.length)];
                        leaf.className = 'leaf ' + randomColor;
                        leaf.style.left = Math.random() * 100 + '%';
                        const duration = Math.random() * 4 + 4;
                        leaf.style.animationDuration = duration + 's';
                        leaf.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(leaf);
                    }
                    break;
                    
                case 'toilet':
                    // „Éà„Ç§„É¨„ÅÆüí©„Åå‰∏äÊòá
                    for (let i = 0; i < 20; i++) {
                        const poop = document.createElement('div');
                        poop.className = 'rising-item';
                        poop.textContent = 'üí©';
                        poop.style.left = Math.random() * 100 + '%';
                        poop.style.fontSize = (Math.random() * 20 + 18) + 'px';
                        const duration = Math.random() * 5 + 4;
                        poop.style.animationDuration = duration + 's';
                        poop.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(poop);
                    }
                    // „Éà„Ç§„É¨„ÅÆËå∂Ëâ≤„ÅÑÊ≥°„Åå‰∏äÊòá
                    for (let i = 0; i < 30; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble toilet-bubble';
                        bubble.style.left = Math.random() * 100 + '%';
                        const size = Math.random() * 15 + 8;
                        bubble.style.width = size + 'px';
                        bubble.style.height = size + 'px';
                        const duration = Math.random() * 5 + 4;
                        bubble.style.animationDuration = duration + 's';
                        bubble.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(bubble);
                    }
                    break;
                    
                case 'music':
                    // Èü≥Ê•Ω„ÅÆÈü≥Á¨¶„ÅåÈôç„Å£„Å¶„Åè„Çã
                    const musicNotes = ['‚ô™', '‚ô´', '‚ô¨'];
                    for (let i = 0; i < 35; i++) {
                        const note = document.createElement('div');
                        note.className = 'falling-item';
                        const selectedNote = musicNotes[Math.floor(Math.random() * musicNotes.length)];
                        note.textContent = selectedNote;
                        note.style.left = Math.random() * 100 + '%';
                        note.style.fontSize = (Math.random() * 25 + 20) + 'px';
                        // ‚ô™„ÅØÈªí„ÄÅ‚ô´‚ô¨„ÅØÁ¥´Á≥ª
                        if (selectedNote === '‚ô™') {
                            note.style.color = '#000000';
                        } else {
                            note.style.color = `hsl(${Math.random() * 60 + 260}, 70%, 60%)`; // Á¥´Á≥ª
                        }
                        const duration = Math.random() * 4 + 3;
                        note.style.animationDuration = duration + 's';
                        note.style.animationDelay = -(Math.random() * duration) + 's';
                        starsContainer.appendChild(note);
                    }
                    break;
            }
        }
        
        // LocalStorage„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        function loadGameData() {
            const savedData = localStorage.getItem('otofuGameData');
            if (savedData) {
                const data = JSON.parse(savedData);
                lastInteraction = data.lastInteraction || Date.now();
                startDate = data.startDate || Date.now();
                collectedStars = data.collectedStars !== undefined ? data.collectedStars : 10;
                lastStarRegenTime = data.lastStarRegenTime || Date.now();
                experience = data.experience || 0;
                rank = data.rank || 1;
                currentCharacter = data.currentCharacter || 'üåö';
                currentBackground = data.currentBackground || 'night';
                unlockedCharacters = data.unlockedCharacters || ['üåö'];
                unlockedBackgrounds = data.unlockedBackgrounds || ['night'];
                username = data.username || 'ÂêçÂâç„ÇíÂÖ•Âäõ';
                ownedDecor = data.ownedDecor || {};
                equippedDecor = data.equippedDecor || [null, null, null];
                decorPlacements = data.decorPlacements || [null, null, null];
                missionProgress = data.missionProgress || { talkCount: 0, pixivCount: 0 };
                claimedMissions = data.claimedMissions || [];
                dailyMissions = data.dailyMissions || [];
                dailyMissionProgress = data.dailyMissionProgress || { dailyTalkCount: 0, dailyPixivCount: 0, openedGacha: false, changedDecor: false };
                lastDailyResetDate = data.lastDailyResetDate || null;
                collectedDiamonds = data.collectedDiamonds || 0;
                diamondSpawnedToday = data.diamondSpawnedToday || false;
                lastDiamondSpawnDate = data.lastDiamondSpawnDate || null;
            } else {
                startDate = Date.now();
                collectedStars = 10;
                lastStarRegenTime = Date.now();
                experience = 0;
                rank = 1;
                currentCharacter = 'üåö';
                currentBackground = 'night';
                unlockedCharacters = ['üåö'];
                unlockedBackgrounds = ['night'];
                username = 'ÂêçÂâç„ÇíÂÖ•Âäõ';
                ownedDecor = {};
                equippedDecor = [null, null, null];
                decorPlacements = [null, null, null];
            }
            
            // ÁâπÂÖ∏„ÇíÈÅ©Áî®
            character.textContent = currentCharacter;
            document.body.className = currentBackground + '-bg';
            generateBackgroundEffect(currentBackground);
            usernameText.textContent = username;
            
            // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ
            if (isTestMode()) {
                collectedStars = 50;
                rank = 100;
                // ÂÖ®„Ç≠„É£„É©„ÇØ„Çø„ÉºËß£Êîæ
                unlockedCharacters = ['üåö', 'üêµ', 'ü§°', 'üåù', 'üê∏', 'ü¶≠', 'üëÅÔ∏è', 'ü¶ß', 'üëπ', 'üëΩ', 'üê≤', 'üåû'];
                // ÂÖ®ËÉåÊôØËß£Êîæ
                unlockedBackgrounds = ['night', 'snow', 'forest', 'rain', 'rainbow', 'city', 'sakura', 'lava', 'aurora', 'dream', 'earth', 'toilet', 'music', 'love'];
                // ÂÖ®È£æ„ÇäËß£ÊîæÔºàÂêÑ1ÂÄãÔºâ
                ownedDecor = {
                    'üéà': 1, 'üç¶': 1, 'üç°': 1, '‚òïÔ∏è': 1,
                    'üéÄ': 1, 'üï∂Ô∏è': 1, 'üé§': 1, 'ü™¥': 1,
                    'üßÅ': 1, 'üçì': 1, 'üéÆ': 1, 'üé©': 1,
                    'ü´ß': 1, 'üß∏': 1
                };
                updateStarCounter();
                updateRankDisplay();
            }
            
            // „ÉÄ„Ç§„É§„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
            updateDiamondCounter();
            
            // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÁîüÊàê
            checkAndResetDailyMissions();
            
            // È£æ„Çä„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderPlaceableDecor();
        }
        
        // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆ„É™„Çª„ÉÉ„Éà„Å®ÁîüÊàê
        function checkAndResetDailyMissions() {
            const today = new Date().toDateString();
            
            // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„Åü„Çâ„É™„Çª„ÉÉ„Éà
            if (lastDailyResetDate !== today) {
                lastDailyResetDate = today;
                dailyMissionProgress = {
                    dailyTalkCount: 0,
                    dailyPixivCount: 0,
                    openedGacha: false,
                    changedDecor: false
                };
                
                // Êñ∞„Åó„ÅÑ„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„Çí3ÂÄãÁîüÊàêÔºö1ÂÄã„ÅØ„ÉÄ„Ç§„É§Â†±ÈÖ¨„ÄÅ2ÂÄã„ÅØÊòüÂ†±ÈÖ¨
                const shuffledDiamond = [...dailyMissionTemplatesDiamond].sort(() => Math.random() - 0.5);
                const shuffledStar = [...dailyMissionTemplatesStar].sort(() => Math.random() - 0.5);
                
                dailyMissions = [
                    { id: `daily_${today}_0`, ...shuffledDiamond[0] }, // 1ÂÄãÁõÆÔºö„ÉÄ„Ç§„É§Â†±ÈÖ¨
                    { id: `daily_${today}_1`, ...shuffledStar[0] },    // 2ÂÄãÁõÆÔºöÊòüÂ†±ÈÖ¨
                    { id: `daily_${today}_2`, ...shuffledStar[1] }     // 3ÂÄãÁõÆÔºöÊòüÂ†±ÈÖ¨
                ];
                
                saveGameData();
            }
            
            // „ÉÄ„Ç§„É§„ÅÆÊó•‰ªò„É™„Çª„ÉÉ„Éà
            if (lastDiamondSpawnDate !== today) {
                diamondSpawnedToday = false;
                lastDiamondSpawnDate = today;
                saveGameData();
            }
        }
        
        // LocalStorage„Å´„Éá„Éº„Çø‰øùÂ≠ò
        function saveGameData() {
            const data = {
                lastInteraction: lastInteraction,
                startDate: startDate,
                collectedStars: collectedStars,
                lastStarRegenTime: lastStarRegenTime,
                experience: experience,
                rank: rank,
                currentCharacter: currentCharacter,
                currentBackground: currentBackground,
                unlockedCharacters: unlockedCharacters,
                unlockedBackgrounds: unlockedBackgrounds,
                username: username,
                ownedDecor: ownedDecor,
                equippedDecor: equippedDecor,
                decorPlacements: decorPlacements,
                missionProgress: missionProgress,
                claimedMissions: claimedMissions,
                dailyMissions: dailyMissions,
                dailyMissionProgress: dailyMissionProgress,
                lastDailyResetDate: lastDailyResetDate,
                collectedDiamonds: collectedDiamonds,
                diamondSpawnedToday: diamondSpawnedToday,
                lastDiamondSpawnDate: lastDiamondSpawnDate
            };
            localStorage.setItem('otofuGameData', JSON.stringify(data));
        }
        
        // Êòü„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        function updateStarCounter() {
            if (isTestMode()) { collectedStars = 50; }
            document.getElementById('star-counter').textContent = `‚≠êÔ∏è √ó ${collectedStars}`;
            updateButtonStates();
        }
        
        // „ÉÄ„Ç§„É§„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        function updateDiamondCounter() {
            document.getElementById('diamond-counter').textContent = `üíé √ó ${collectedDiamonds}`;
        }
        
        // „É©„É≥„ÇØË°®Á§∫Êõ¥Êñ∞
        function updateRankDisplay() {
            document.getElementById('rank-display').textContent = `Rank ${rank}`;
        }
        
        // ÁµåÈ®ìÂÄ§„ÇíËøΩÂä†„Åó„Å¶„É©„É≥„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function addExperience(amount) {
            experience += amount;
            
            // „É©„É≥„ÇØ„Ç¢„ÉÉ„Éó„ÅÆË®àÁÆóÔºà100ÁµåÈ®ìÂÄ§„Åî„Å®„Å´„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
            const newRank = Math.floor(experience / 100) + 1;
            
            if (newRank > rank && newRank <= maxRank) {
                rank = newRank;
                updateRankDisplay();
                showDialogue(`„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅRank ${rank} „Å´„Å™„Å£„Åüüéâ`, true);
            }
            
            saveGameData();
        }
        
        // „Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°ÂäπÁä∂ÊÖãÊõ¥Êñ∞
        function updateButtonStates() {
            const pixivBtn = document.getElementById('pixiv-btn');
            const gachaBtn = document.getElementById('gacha-btn');
            
            if (collectedStars >= 3) {
                pixivBtn.classList.remove('disabled');
            } else {
                pixivBtn.classList.add('disabled');
            }
            
            if (collectedStars >= 10) {
                gachaBtn.classList.remove('disabled');
            } else {
                gachaBtn.classList.add('disabled');
            }
        }
        
        // Êó•Êï∞„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        // Êó¢Â≠ò„ÅÆÊòü„ÇíÊõ¥Êñ∞Ôºà„Ç≠„É£„É©„ÇØ„Çø„ÉºÂ§âÊõ¥ÊôÇÔºâ
        function updateExistingStars() {
            const stars = document.querySelectorAll('.collectible-star');
            let starColors;
            
            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Å´Âøú„Åò„Å¶Êòü„ÅÆÁ®ÆÈ°û„ÇíË®≠ÂÆö
            switch(currentCharacter) {
                case 'ü§°': // „Éî„Ç®„É≠
                    starColors = ['ü©∏', 'üî™'];
                    break;
                case 'üêµ': // „Çµ„É´
                    starColors = ['üçå', '‚ùì'];
                    break;
                case 'üåù': // „É†„Éº„É≥
                    starColors = ['üí´', '‚ú®'];
                    break;
                case 'üê∏': // „Ç´„Ç®„É´
                    starColors = ['üíß', 'üíö'];
                    break;
                case 'ü¶≠': // „Ç¢„Ç∂„É©„Ç∑
                    starColors = ['üßä', 'üêü'];
                    break;
                case 'üëÅÔ∏è': // „Ç¢„Ç§
                    starColors = ['üëª', 'üñ§'];
                    break;
                case 'ü¶ß': // „Ç™„É©„É≥„Ç¶„Éº„Çø„É≥
                    starColors = ['üçå', 'üçé'];
                    break;
                case 'üí©': // „ÅÜ„Çì„Å°
                    starColors = ['ü§é', 'üßª'];
                    break;
                case 'ü•∫': // „Å¥„Åà„Çì
                    starColors = ['‚ö´Ô∏è', 'üü°'];
                    break;
                case 'üëπ': // „Ç™„Éã
                    starColors = ['ü©∏', 'üî™'];
                    break;
                case 'üëΩ': // „Ç®„Ç§„É™„Ç¢„É≥
                    starColors = ['üöÄ', 'üëæ'];
                    break;
                case 'üê≤': // „Éâ„É©„Ç¥„É≥
                    starColors = ['üî•', 'üîÆ'];
                    break;
                case 'üåû': // „Çµ„É≥
                    starColors = ['‚òÄÔ∏è', '‚ú®'];
                    break;
                default: // „Éá„Éï„Ç©„É´„ÉàÔºàüåö„Å™„Å©Ôºâ
                    starColors = ['‚≠êÔ∏è', 'üåü'];
            }
            
            stars.forEach(star => {
                // „ÉÄ„Ç§„É§„ÅØ„Åù„ÅÆ„Åæ„ÅæÁ∂≠ÊåÅ
                if (star.dataset.isDiamond === 'true') {
                    return;
                }
                // „É©„É≥„ÉÄ„É†„Å´Êòü„ÅÆÁ®ÆÈ°û„ÇíÂÜçË®≠ÂÆö
                star.textContent = starColors[Math.floor(Math.random() * starColors.length)];
            });
        }
        
        // ÂèéÈõÜÂèØËÉΩ„Å™Êòü„ÇíÁîüÊàê
        function spawnCollectibleStars() {
            if (collectibleStarsArray.length >= 10) return;
            
            const star = document.createElement('div');
            star.className = 'collectible-star';
            
            // 1Êó•1Âõû„ÄÅ5%„ÅÆÁ¢∫Áéá„Åß„ÉÄ„Ç§„É§„ÇíÁîüÊàê
            const isDiamond = !diamondSpawnedToday && Math.random() < 0.05;
            
            if (isDiamond) {
                star.textContent = 'üíé';
                star.dataset.isDiamond = 'true';
                diamondSpawnedToday = true;
                saveGameData();
            } else {
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„Å´Âøú„Åò„Å¶Êòü„ÅÆÁ®ÆÈ°û„ÇíÂ§âÊõ¥
                let starColors;
                switch(currentCharacter) {
                    case 'ü§°': // „Éî„Ç®„É≠
                        starColors = ['ü©∏', 'üî™'];
                        break;
                    case 'üêµ': // „Çµ„É´
                        starColors = ['üçå', '‚ùì'];
                        break;
                    case 'üåù': // „É†„Éº„É≥
                        starColors = ['üí´', '‚ú®'];
                        break;
                    case 'üê∏': // „Ç´„Ç®„É´
                        starColors = ['üíß', 'üíö'];
                        break;
                    case 'ü¶≠': // „Ç¢„Ç∂„É©„Ç∑
                        starColors = ['üßä', 'üêü'];
                        break;
                    case 'üëÅÔ∏è': // „Ç¢„Ç§
                        starColors = ['üëª', 'üñ§'];
                        break;
                    case 'ü¶ß': // „Ç™„É©„É≥„Ç¶„Éº„Çø„É≥
                        starColors = ['üçå', 'üçé'];
                        break;
                    case 'üí©': // „ÅÜ„Çì„Å°
                        starColors = ['ü§é', 'üßª'];
                        break;
                    case 'ü•∫': // „Å¥„Åà„Çì
                        starColors = ['‚ö´Ô∏è', 'üü°'];
                        break;
                    case 'üëπ': // „Ç™„Éã
                        starColors = ['ü©∏', 'üî™'];
                        break;
                    case 'üëΩ': // „Ç®„Ç§„É™„Ç¢„É≥
                        starColors = ['üöÄ', 'üëæ'];
                        break;
                    case 'üê≤': // „Éâ„É©„Ç¥„É≥
                        starColors = ['üî•', 'üîÆ'];
                        break;
                    case 'üåû': // „Çµ„É≥
                        starColors = ['‚òÄÔ∏è', '‚ú®'];
                        break;
                    default: // „Éá„Éï„Ç©„É´„ÉàÔºàüåö„Å™„Å©Ôºâ
                        starColors = ['‚≠êÔ∏è', 'üåü'];
                }
                star.textContent = starColors[Math.floor(Math.random() * starColors.length)];
            }
            
            // üåö„ÅÆÂë®„Çä„Å´„É©„É≥„ÉÄ„É†„Å´ÈÖçÁΩÆÔºàÂÖ®‰ΩìÁöÑ„Å´Â∞ë„Åó‰∏ã„Å´Ôºâ
            let x, y;
            const angle = Math.random() * Math.PI * 2;
            const distance = 80 + Math.random() * 100;
            x = Math.cos(angle) * distance;
            y = Math.sin(angle) * distance;
            
            // Êòü„Ç´„Ç¶„É≥„Çø„Éº„ÅÆÈ´ò„Åï„ÇíÂèñÂæóÔºàÁ¥Ñ80pxÁ®ãÂ∫¶Ôºâ
            const minTopPosition = 100; // Êòü„Ç´„Ç¶„É≥„Çø„ÉºË°®Á§∫„ÅÆ‰∏ã
            
            // Ë®àÁÆó„Åï„Çå„Åü‰ΩçÁΩÆ
            const calculatedTop = window.innerHeight * 0.55 + y;
            
            // minTopPosition„Çà„Çä‰∏ä„Å´„ÅØÈÖçÁΩÆ„Åó„Å™„ÅÑ
            if (calculatedTop < minTopPosition) {
                // ‰∏ä„Å´Âá∫„Å¶„Åó„Åæ„ÅÜÂ†¥Âêà„ÅØ„ÄÅ‰∏ãÂÅ¥„Å´ÈÖçÁΩÆ
                y = Math.abs(y);
            }
            
            star.style.left = `calc(50% + ${x}px)`;
            star.style.top = `calc(55% + ${y}px)`;
            star.style.animationDelay = Math.random() * 2 + 's';
            
            // „Çø„ÉÉ„Éó„Ç§„Éô„É≥„Éà
            star.addEventListener('click', (e) => {
                e.stopPropagation();
                collectStar(star);
            });
            
            star.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                collectStar(star);
            });
            
            characterArea.appendChild(star);
            collectibleStarsArray.push(star);
        }
        
        // Êòü„ÇíÂõûÂèé
        function collectStar(starElement) {
            if (!starElement) return;
            if (starElement.classList.contains('collected')) return;
            
            const isDiamond = starElement.dataset.isDiamond === 'true';
            
            if (isDiamond) {
                // „ÉÄ„Ç§„É§„ÇíÂõûÂèé
                if (collectedDiamonds >= maxDiamonds) return;
                starElement.classList.add('collected');
                collectedDiamonds++;
                updateDiamondCounter();
                addExperience(10);
                saveGameData();
                playStarSound();
            } else {
                // Êòü„ÇíÂõûÂèé
                if (collectedStars >= maxStars) return;
                starElement.classList.add('collected');
                collectedStars++;
                updateStarCounter();
                addExperience(10);
                saveGameData();
                playStarSound();
            }
            
            setTimeout(() => {
                if (starElement && starElement.parentNode) {
                    starElement.parentNode.removeChild(starElement);
                }
                const index = collectibleStarsArray.indexOf(starElement);
                if (index > -1) {
                    collectibleStarsArray.splice(index, 1);
                }
            }, 500);
        }
        
        // „Éú„Éº„Éä„ÇπÊúà„ÇíÁîüÊàê
        function spawnBonusMoon() {
            if (bonusMoonActive) return;
            
            const now = Date.now();
            // ÊúÄÂæå„ÅÆ„Éú„Éº„Éä„ÇπÊúà„Åã„ÇâÂ∞ë„Å™„Åè„Å®„ÇÇ2ÂàÜÁµåÈÅé„Åó„Å¶„ÅÑ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
            if (now - lastBonusMoonTime < 120000) return;
            
            bonusMoonActive = true;
            lastBonusMoonTime = now;
            
            const moon = document.createElement('div');
            moon.className = 'bonus-moon';
            moon.textContent = 'üåõ';
            
            // Êòü„Ç´„Ç¶„É≥„Çø„Éº„Çà„Çä‰∏ã„Å´ÈÖçÁΩÆÔºà15%„Äú80%„ÅÆÁØÑÂõ≤Ôºâ
            const topPosition = Math.random() * 65 + 15; // 15-80%„ÅÆÁØÑÂõ≤
            moon.style.top = topPosition + '%';
            moon.style.left = '-100px';
            
            // „Çø„ÉÉ„Éó„Ç§„Éô„É≥„Éà
            moon.addEventListener('click', (e) => {
                e.stopPropagation();
                collectBonusMoon(moon);
            });
            
            moon.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                collectBonusMoon(moon);
            });
            
            document.getElementById('game-container').appendChild(moon);
            
            // 8ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæåÔºâ
            setTimeout(() => {
                if (moon && moon.parentNode) {
                    moon.parentNode.removeChild(moon);
                }
                bonusMoonActive = false;
            }, 8000);
        }
        
        // „Éú„Éº„Éä„ÇπÊúà„ÇíÂõûÂèé
        function collectBonusMoon(moonElement) {
            if (!moonElement || moonElement.classList.contains('collected')) return;
            
            moonElement.classList.add('collected');
            
            // Êòü„Çí20ÂÄãËøΩÂä†ÔºàÊúÄÂ§ßÂÄ§„ÇíË∂Ö„Åà„Å™„ÅÑÔºâ
            const starsToAdd = Math.min(20, maxStars - collectedStars);
            collectedStars += starsToAdd;
            updateStarCounter();
            addExperience(50);
            saveGameData();
            
            playStarSound();
            
            // ÁâπÂà•„Å™„Çª„É™„Éï
            const bonusDialogues = [
                '„Éú„Éº„Éä„Çπ„Åç„Åüüåõ‚ú®',
                '„É©„ÉÉ„Ç≠„Éºüåõüåü',
                '„ÅÜ„Åä„Åä„Åäüåõüåõ',
                '„Åæ„Åò„Åãüåõ‚ú®‚ú®',
                'Á•ûÂºï„Åçüåõü§°'
            ];
            showDialogue(bonusDialogues[Math.floor(Math.random() * bonusDialogues.length)]);
            
            setTimeout(() => {
                if (moonElement && moonElement.parentNode) {
                    moonElement.parentNode.removeChild(moonElement);
                }
                bonusMoonActive = false;
            }, 500);
        }
        
        // È£æ„Çä„ÅÆÈÖçÁΩÆÁØÑÂõ≤„ÇíÂèñÂæó
        function getPlacementBounds() {
            const gameRect = gameContainer.getBoundingClientRect();
            const statusArea = document.getElementById('interaction-area');
            const usernameArea = document.getElementById('username-display');
            const rankArea = document.getElementById('rank-display');

            let top = 0;
            let bottom = gameRect.height;

            // ‰∏äÈÉ®„ÅÆUIÔºà„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÄÅ„É©„É≥„ÇØÔºâ„ÅÆ‰∏ã
            if (usernameArea || rankArea) {
                top = 120; // Âõ∫ÂÆöÂÄ§
            }
            
            // ‰∏ãÈÉ®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Ç®„É™„Ç¢„ÅÆ‰∏ä
            if (statusArea) {
                const r = statusArea.getBoundingClientRect();
                bottom = Math.min(bottom, (r.top - gameRect.top) - 20);
            }

            return {
                top: top,
                bottom: bottom,
                width: gameRect.width,
                height: bottom - top
            };
        }

        // „Éá„Éï„Ç©„É´„Éà„ÅÆÈÖçÁΩÆ‰ΩçÁΩÆ
        function defaultPlacementForSlot(slot, bounds) {
            const positions = [
                { x: 0.15, y: 0.3 },  // Â∑¶‰∏ä
                { x: 0.75, y: 0.3 },  // Âè≥‰∏ä
                { x: 0.5, y: 0.6 }    // ‰∏≠Â§Æ‰∏ã
            ];
            return positions[slot] || { x: 0.5, y: 0.5 };
        }

        // clampÈñ¢Êï∞
        function clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // È£æ„Çä„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderPlaceableDecor() {
            if (!placementArea) return;

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫‰∏≠„ÅØÈùûË°®Á§∫
            if (document.body.classList.contains('modal-open') || 
                closetModal.classList.contains('show') || 
                gachaModal.classList.contains('show') || 
                usernameModal.classList.contains('show') ||
                rankModal.classList.contains('show')) {
                placementArea.style.display = 'none';
                return;
            }
            
            placementArea.style.display = '';
            placementArea.innerHTML = '';

            const bounds = getPlacementBounds();

            for (let i = 0; i < 3; i++) {
                const emoji = equippedDecor[i];
                if (!emoji) continue;

                if (!decorPlacements[i]) decorPlacements[i] = defaultPlacementForSlot(i, bounds);

                const el = document.createElement('div');
                el.className = 'placeable-decor';
                el.textContent = emoji;
                el.dataset.slot = String(i);

                const px = decorPlacements[i].x * bounds.width;
                const py = bounds.top + (decorPlacements[i].y * bounds.height);
                el.style.left = `${px}px`;
                el.style.top = `${py}px`;

                let dragging = false;
                let longPressTimer = null;
                let offsetX = 0;
                let offsetY = 0;
                let startX = 0;
                let startY = 0;
                let hasMoved = false;

                const onDown = (e) => {
                    if (document.body.classList.contains('modal-open')) return;
                    
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    startX = clientX;
                    startY = clientY;
                    hasMoved = false;
                    
                    const rect = el.getBoundingClientRect();
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;
                    
                    // Èï∑Êäº„ÅóÂà§ÂÆöÔºà300msÔºâ
                    longPressTimer = setTimeout(() => {
                        dragging = true;
                        el.classList.add('dragging');
                    }, 300);
                };

                const cancelLongPress = () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                };

                const onMove = (e) => {
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    // ÁßªÂãïË∑ùÈõ¢Ë®àÁÆó
                    const distance = Math.sqrt(Math.pow(clientX - startX, 2) + Math.pow(clientY - startY, 2));
                    
                    if (!dragging) {
                        // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÂâçÔºö10px‰ª•‰∏äÂãï„ÅÑ„Åü„Çâ„Ç≠„É£„É≥„Çª„É´
                        if (distance > 10) {
                            hasMoved = true;
                            cancelLongPress();
                        }
                        return;
                    }
                    
                    // „Éâ„É©„ÉÉ„Ç∞‰∏≠
                    e.preventDefault();
                    e.stopPropagation();

                    const gameRect = gameContainer.getBoundingClientRect();
                    const b = getPlacementBounds();
                    const rect = el.getBoundingClientRect();

                    const x = (clientX - gameRect.left) - offsetX;
                    const y = (clientY - gameRect.top) - offsetY;

                    const maxX = b.width - rect.width;
                    const minY = b.top;
                    const maxY = b.bottom - rect.height;

                    const cx = clamp(x, 0, maxX);
                    const cy = clamp(y, minY, maxY);

                    el.style.left = `${cx}px`;
                    el.style.top = `${cy}px`;
                };

                const onUp = (e) => {
                    cancelLongPress();
                    
                    if (!dragging) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    dragging = false;
                    el.classList.remove('dragging');
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÆåÂÖ®„Å´ÂÅúÊ≠¢
                    el.style.animation = 'none';
                    
                    // 0.1ÁßíÂæå„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÜçÈñãÔºà„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®ÂêåÊúüÔºâ
                    setTimeout(() => {
                        el.style.animation = 'float 3s ease-in-out infinite';
                    }, 100);

                    const gameRect = gameContainer.getBoundingClientRect();
                    const b = getPlacementBounds();
                    const rect = el.getBoundingClientRect();

                    const x = rect.left - gameRect.left;
                    const y = rect.top - gameRect.top;

                    decorPlacements[i] = {
                        x: x / b.width,
                        y: (y - b.top) / b.height
                    };
                    saveGameData();
                };

                el.addEventListener('mousedown', onDown);
                el.addEventListener('mousemove', onMove);
                el.addEventListener('mouseup', onUp);
                el.addEventListener('mouseleave', () => {
                    if (!dragging) {
                        cancelLongPress();
                    }
                });
                el.addEventListener('touchstart', onDown, { passive: true });
                el.addEventListener('touchmove', onMove, { passive: false });
                el.addEventListener('touchend', onUp, { passive: false });
                el.addEventListener('touchcancel', () => {
                    cancelLongPress();
                    if (dragging) {
                        el.classList.remove('dragging');
                        dragging = false;
                    }
                }, { passive: true });

                placementArea.appendChild(el);
            }
        }

        // ÂäπÊûúÈü≥
        function playSound(frequency, duration, volume = 0.3) {
            // ÂàùÂõû„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´È≥¥„Çâ„ÅôÂâçÊèê„ÄÇÂøµ„ÅÆ„Åü„ÇÅÂÜçÈñã„ÇíË©¶„Åô
            resumeAudio();

            // seContext / seMasterGain „ÅØ initAudioGraph() „ÅßÁî®ÊÑè„Åï„Çå„Çã
            if (!seContext || !seMasterGain) return;

            const oscillator = seContext.createOscillator();
            const gainNode = seContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(seMasterGain);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            // ÂÄãÂà•Èü≥Èáè * „Éû„Çπ„Çø„ÉºÔºà„Çπ„É©„Ç§„ÉÄ„ÉºÔºâ „ÅßÊúÄÁµÇÈü≥Èáè
            const base = Math.max(0.0001, volume);
            gainNode.gain.setValueAtTime(base, seContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, seContext.currentTime + duration);

            oscillator.start(seContext.currentTime);
            oscillator.stop(seContext.currentTime + duration);
        }
        
        function playStarSound() {
            playSound(800, 0.15, 0.2);
            setTimeout(() => playSound(1000, 0.1, 0.15), 50);
        }
        
        function playCharacterSound() {
            playSound(300, 0.1, 0.25);
        }
        
        function playActionSound() {
            playSound(700, 0.12, 0.2);
            setTimeout(() => playSound(900, 0.12, 0.18), 60);
            setTimeout(() => playSound(1100, 0.15, 0.15), 120);
        }
        
        // „Çª„É™„Éï„Éá„Éº„Çø
        const allDialogues = [
            "„ÇìÔºü„Å™„Å´Ôºüüåö", "„Åä„Åò„Åï„Çì‰ªäÂøô„Åó„ÅÑ„Çì„Å†„Åë„Å©üôâ", "„Çø„ÉÉ„Éó„Åô„Çì„Å™„Çà...ü§°ü§°",
            "„Åæ„ÅÇ„ÅÑ„ÅÑ„Åë„Å©„Åïüê∏", "‰Ωï„ÅãÁî®Ôºüü•∞", "Ë©±„Åó„Åã„Åë„Å¶„Åè„Çå„Çã„ÅÆÔºüüåöüåö",
            "„ÅØ„ÅÅ...„Åæ„Åò„ÅßÁµµÊèè„Åë„Å™„ÅÑ„Çì„Å†„Çà„Å™üåöüåö", "„Åä„Åò„Åï„ÇìÁóÖ„Çì„Åß„Çã„Çèüê∏üê∏",
            "„É°„É≥„Çø„É´„ÇÑ„Å∞„ÅÑüôâüôâ", "„Åæ„Åò„Åã...„Åæ„ÅüÊèè„Åë„Å™„ÅÑüôâüê∏",
            "ÊßãÂõ≥Á†¥Á∂ª„Åó„Å¶„Çã„Çèü§°ü§°", "Ëá™ÂàÜ„ÅÆÁµµ„Åå‰∏ãÊâã„Åô„Åé„Çãü•∞ü•∞",
            "pixivË¶ã„Å¶„Åü„ÇâÊôÇÈñìÊ∫∂„Åë„Åüü§°ü§°", "TwitterË¶ã„Çã„Å†„Åë„ÅÆÊó•„ÄÖ„Å™„Çì„Å†„Çà„Å™üåö",
            "BLÊº´ÁîªË™≠„Çì„Åß„Çã„Åª„ÅÜ„Åå„Éû„Ç∑üôâüôâ", "„Çπ„É©„É≥„Éó„Åô„Åé„Å¶Ëæõ„ÅÑü•∞ü•∞",
            "Á≠ãËÇâÊèè„Åë„Å™„ÅÑ„Çì„Å†„Çà„Å™...üåöüåö", "„Çπ„Éö„Éº„ÇπËÅ¥„ÅÑ„Å¶„ÇÇÊèè„Åë„Å™„ÅÑü•∞",
            "Ë§êËâ≤Áî∑Â≠êÊèè„Åç„Åü„ÅÑ„ÅÆ„Å´Êèè„Åë„Å™„ÅÑüåö", "ËÑá„Éï„Çß„ÉÅ„Å™„ÅÆ„Å´ËÑá„ÅåÊèè„Åë„Å™„ÅÑü•∞ü•∞",
            "„Åæ„Åò„Åß‰ªäÊó•Ë™øÂ≠ê„ÅÑ„ÅÑÔºÅü•∞ü•∞", "ÁµµÊèè„Åè„ÅÆ„Åæ„Åò„ÅßÊ•Ω„Åó„ÅÑÔºÅüåöüåö",
            "„Åì„ÅÆÊßãÂõ≥ÂÆåÁíß„Åò„ÇÉ„Çìü§°ü§°", "„Éï„Ç©„É≠„ÉØ„ÉºÂ¢ó„Åà„Å¶Â¨â„Åó„ÅÑüê∏üê∏",
            "„ÅÑ„ÅÑ„Å≠„Åü„Åè„Åï„Çì„Å§„ÅÑ„ÅüÔºÅüôâü•∞", "RT„Åï„Çå„Åæ„Åè„Å£„Å¶„Çãü§°üåö",
            "Á≠ãËÇâÂÆåÁíß„Å´Êèè„Åë„ÅüÔºÅü•∞ü•∞", "„ÇÅ„Å°„ÇÉ„Åè„Å°„ÇÉ„ÅÑ„ÅÑÁµµÊèè„Åë„Åüüåöüåö",
            "„Åæ„Åò„Åã„ÄÅ„Éê„Ç∫„Å£„Å¶„Çãüê∏ü§°", "„Åì„ÅÆÁ≠ãËÇâ„Åà„Å£„Å°„Å†„Å™üôâüôâ",
            "„Åß„ÇÇ„Åæ„Å†ÊîπÂñÑÁÇπ„ÅÇ„Çã„Å™ü•∞", "‰ªñ„ÅÆ‰∫∫„Å®ÊØî„Åπ„Åü„ÇâÂæÆÂ¶ô„Åã„ÇÇü§°ü§°",
            "Ëâ≤Â°ó„Çä„Ç¥„Éü„Åô„Åéüåöüåö", "Á∑öÁîªÊ±ö„Åô„Åé„Å¶ÁÑ°ÁêÜü•∞ü•∞",
            "Áµµ„ÅåÊ∞óÊåÅ„Å°ÊÇ™„ÅÑüôâüôâ", "„Éê„É©„É≥„Çπ„Åä„Åã„Åó„ÅÑ„Çì„Å†„Çà„Å™ü§°üê∏",
            
            // „Å°„ÅÑ„Åã„ÇèÈñ¢ÈÄ£
            "„Å°„ÅÑ„Åã„ÇèÂèØÊÑõ„Åô„Åé„ÇÑ„Ççü•∞ü•∞",
            "„Å°„ÅÑ„Åã„Çè„Ç∞„ÉÉ„Ç∫Ê¨≤„Åó„ÅÑüåöüåö", "„Å°„ÅÑ„Åã„ÇèË¶ã„Å¶„Çã„Å®Áôí„Åï„Çå„Çãüê∏üê∏",
            
            // „Éú„É≥„Éê„Éº„Åï„ÇìÈñ¢ÈÄ£
            "„Éú„É≥„Éê„Éº„Åï„Çì„ÅÆÁµµ„Åæ„Åò„ÅßÂ•Ω„Åçü§°ü§°", "„Éú„É≥„Éê„Éº„Åï„Çì„ÅÆÂ°ó„ÇäÁ•û„Åô„Åé„Çãü•∞ü•∞",
            "„Éú„É≥„Éê„Éº„Åï„Çì„Åø„Åü„ÅÑ„Å´Êèè„Åç„Åü„ÅÑüåöüåö",
            
            // „Ç®„É≥„Éö„É©ÊßòÈñ¢ÈÄ£
            "„Ç®„É≥„Éö„É©Êßò„ÅÆÊñ∞‰Ωú„Åç„ÅüÔºÅüôâüôâ",
            "„Ç®„É≥„Éö„É©Êßò„ÅÆÂãïÁîªË¶ã„Çã„Åúü§°ü§°", "„Ç®„É≥„Éö„É©ÊßòÊúÄÈ´ò„Å™„Çì„Å†„Çà„Å™ü•∞ü•∞",
            "„Ç®„É≥„Éö„É©Êßò„ÅÆÂÆüÊ≥Å„Åä„ÇÇ„Çç„ÅÑüåöüåö", "„Ç®„É≥„Éö„É©Êßò„ÅÆÊñ∞‰ΩúÂæÖ„Å£„Å¶„Åüüê∏üê∏",
            
            // „Ç∑„Éô„É™„Ç¢„É≥„Éè„Çπ„Ç≠„Éº„ÉªÁãºÁä¨Èñ¢ÈÄ£
            "Â≠êÁä¨„ÅÆÂãïÁîªË¶ã„Å¶„Çã„Å®Âπ∏„Åõü•∞ü•∞", "„Éè„Çπ„Ç≠„Éº„Åã„Çè„ÅÑ„Åô„Åé„ÇÑ„Ççüåöüåö",
            "YouTubeË¶ã„Å¶„Åü„ÇâÊôÇÈñìÊ∫∂„Åë„Åüüê∏üê∏",
            
            // ‰ªï‰∫ãÂ´å„ÅÑ
            "‰ªï‰∫ãË°å„Åç„Åü„Åè„Å™„ÅÑüåöüåö", "‰ªï‰∫ãËæõ„Åô„Åé„Çãüê∏üê∏",
            "‰ªï‰∫ã„ÇÑ„ÇÅ„Åü„ÅÑüôâüôâ", "Áµµ„Å†„ÅëÊèè„ÅÑ„Å¶Áîü„Åç„Åü„ÅÑü•∞ü•∞",
            
            // ‰∫åÊ¨°ÂÖÉ„ÅÆÁî∑„ÅÆÂ•Ω„Åø
            "Ë§êËâ≤ËÇå„Åà„Å£„Å°„Åô„Åé„Çãü§°ü§°",
            "ËÑá„Åæ„Åò„ÅßÂ•Ω„Åçü•∞ü•∞", "ËÖπÁ≠ã„ÇÑ„Å∞„ÅÑüåöüåö",
            "„Éî„Ç¢„Çπ„Å§„ÅÑ„Å¶„ÇãÁî∑Â•Ω„Åçüê∏üê∏", "„Éà„É©„Ç§„Éê„É´„Çø„Éà„Ç•„Éº„Åà„Å£„Å°üôâüôâ",
            "Èªí„Çø„É≥„ÇØ„Éà„ÉÉ„Éó„ÅÆÁ≠ãËÇâ„Åæ„Åò„ÅßÂ∞ä„ÅÑü•∞ü•∞",
            
            // È£ü‰∫ãÈñ¢ÈÄ£
            "ËíôÂè§„Çø„É≥„É°„É≥È£ü„Åπ„Åü„ÅÑüåöüåö", "Ëæõ„ÅÑ„ÇÇ„ÅÆÈ£ü„Åπ„Çã„Åúüê∏üê∏",
            "‰ªäÊó•„ÅØ„ÅÇ„Çì„ÅæÈ£ü„Åπ„Å¶„Å™„ÅÑüôâ",
            
            // ‰∏ã„Éç„Çø
            "„Å°„Çì„Å°„Çìü§°", "„Å°„Çì„Å°„ÇìÊèè„Åç„Åü„ÅÑüôâüôâ",
            
            // Áµµ„Å∏„ÅÆ„Çπ„Éà„Ç§„ÉÉ„ÇØ„Åï„Éª„Çπ„É©„É≥„Éó
            "„ÇÇ„Å£„Å®‰∏äÊâã„Åè„Å™„Çä„Åü„ÅÑüåöüåö", "„Åæ„Å®„ÇÇ„Å™Áµµ„ÅåÊèè„Åë„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åü„ÅÑü•∞ü•∞",
            "„Ç≥„É≥„Éà„É©„Éù„Çπ„Éà„ÅåÊ±∫„Åæ„Çâ„Å™„ÅÑüôâüôâ", "ÁµµÊüÑÂàÜÊûê„Åó„Å¶„Åü„ÇâÊôÇÈñìÊ∫∂„Åë„Åüü§°ü§°",
            "‰ªäÊó•„ÅØ„Çπ„É©„É≥„Éó„Å†„Çèüê∏üê∏", "Áµµ„Åå‰∏ãÊâã„Åô„Åé„Å¶Ê≠ª„Å´„Åü„ÅÑüåöüåö",
            "1‰∏á„ÅÑ„ÅÑ„Å≠ÁõÆÊåá„Åô„Åúü•∞ü•∞", "Âπ≥Âùá1‰∏á„ÅÑ„ÅÑ„Å≠„Å™„Çì„Å†„Åë„Å©„Å™ü§°",
            
            // ÈçµÂû¢ÂºïÁî®„ÉªÊÇ™Âè£
            "È°îÁ†¥Á∂ª„Åó„Å¶„ÇãÁµµ„ÅßÁ¨ë„Å£„Å¶„Åó„Åæ„ÅÜüôâüôâ", "„Åì„ÅÆÁµµÈ°î„Åä„Åã„Åó„ÅÑ„Å†„Ççü§°ü§°",
            "„Éá„ÉÉ„Çµ„É≥ÁãÇ„ÅÑ„Åô„Åé„ÇÑ„Ççüåöüåö", "„Åì„ÅÆÁµµ„ÅßÁ¨ë„Å£„Å¶„Åó„Åæ„ÅÜüê∏üê∏",
            
            // Âè£Áôñ
            "„Åì„ÅÆÊßãÂõ≥„Åô„Åé„ÇÑ„Ççü§°ü§°",
            "‰ªäÊó•„ÅØÁ≠ãËÇâÊèè„Åè„Åúü•∞ü•∞",
            "„Ç≥„É≥„Éà„É©„Éù„Çπ„ÉàÊÑèË≠ò„Åô„Çã„Åúüåöüåö", "ÁµµÊüÑÂàÜÊûê„Åô„Çã„Åãüê∏üê∏",
            "„ÇÇ„Å£„Å®‰∏äÊâã„Åè„Å™„Çä„Åü„ÅÑü•∞ü•∞", "„Åì„ÅÆËÑá„Åô„Åé„ÇÑ„Ççü§°ü§°",
            "‰ªäÊó•„ÅØË§êËâ≤Êèè„Åè„Åúüôâüôâ"
        ];
        
        // pixiv„Ç≥„Éû„É≥„ÉâÁî®
        const pixivCharacters = ['ÈâÑËôé', '„Ç´„É™„É†', 'Á¥óÊúà', '‰∏â„ÉÑË∞∑', '‰∫åÈÉé', '„Ç∑„É´„Éê„Éº', 'Â∑¶È¶¨Âàª', '„É®„Éä', '„Åä„Åò„Åü„Çì', '„Ç§„Éå„Éî„Éº', '„Ç¢„Éâ„Éã„Çπ', 'ÂÖ´Êàí', 'Á©∫Âç¥'];
        const pixivParts = ['ËÑá', 'Á≠ãËÇâ', 'ËÖπÁ≠ã', 'ËÉ∏Á≠ã', 'ËÑá'];
        
        function getPixivDialogue() {
            const char = pixivCharacters[Math.floor(Math.random() * pixivCharacters.length)];
            const part = pixivParts[Math.floor(Math.random() * pixivParts.length)];
            const patterns = [
                `${char}„ÅÆ${part}„Åà„Å£„Å°„Åô„Åé„Çãü§°ü§°`,
                `${char}„ÅÆ${part}„Ç®„É≠„ÅÑü•∞ü•∞`,
                `${char}„ÅÆ${part}„Åæ„Åò„ÅßÂ•Ω„Åçüåöüåö`,
                `${char}„ÅÆ${part}„ÇÑ„Å∞„ÅÑüôâüê∏`,
                `${char}„ÅÆ${part}ÊúÄÈ´ò„Å™„Çì„Å†„Çà„Å™ü§°ü•∞`,
                `${char}„ÅÆ${part}Ë¶ã„Å¶„Çã„Å®ËààÂ•Æ„Åô„Çãüåöüåö`,
                `${char}„ÅÆ${part}„Åß„ÅîÈ£Ø3ÊùØ„ÅÑ„Åë„Çãüê∏üê∏`,
                `${char}„ÅÆ${part}Êèè„Åç„Åü„ÅÑüôâüôâ`,
                `${char}„ÅÆ${part}Â∞ä„ÅÑü§°ü§°`,
                `${char}„ÅÆ${part}„Åæ„Åò„Ç®„É≠„ÅÑü•∞üåö`
            ];
            return patterns[Math.floor(Math.random() * patterns.length)];
        }
        
        const pixivDialogues = [
            "pixivË¶ã„Å¶„Åü„ÇâÊôÇÈñìÊ∫∂„Åë„Åüü§°ü§°",
            "pixiv„ÅÆÁµµ„Åæ„Åò„Åß„É¨„Éô„É´È´ò„ÅÑüôâüê∏",
            "pixivÂ∑°Âõû„Åô„Çã„Åãüåöüåö",
            "pixiv„ÅßËâØ„ÅÑÁµµË¶ã„Å§„Åë„Åüü•∞ü•∞"
        ];
        
        const foodDialogues = [
            "Áâõ„Çø„É≥ÔºÅÔºÅÂÉï„Åì„ÇåÂ§ßÂ•Ω„Åç„Å™„Çì„Å†„Çà„Å™ü•∞", "„Ç´„É´„Éú„Éä„Éº„É©„Åæ„Åò„ÅßÊúÄÈ´òüåö",
            "ËíôÂè§„Çø„É≥„É°„É≥Ëæõ„ÅÑ„Åë„Å©Â•Ω„Åçüê∏", "„É©„Éº„É°„É≥„ÅÜ„Åæ„ÅÑÔºÅüôâ", "È∫ªËæ£ÊπØÁó∫„Çå„Çã„Äúü§°"
        ];
        
        const praiseDialogues = [
            "„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅüåö", "„Åù„ÅÜÔºüÂ¨â„Åó„ÅÑü•∞", "„Åä„Åò„Åï„ÇìÈ†ëÂºµ„Å£„Åüüê∏",
            "Ë§í„ÇÅ„Çâ„Çå„Çã„Å®‰º∏„Å≥„Çã„Çø„Ç§„Éóüôâ", "„ÇÇ„Å£„Å®Ë§í„ÇÅ„Å¶ü§°"
        ];
        
        function getRandomDialogue() {
            return allDialogues[Math.floor(Math.random() * allDialogues.length)];
        }
        
        // Ë°åÂãï„É°„ÉÉ„Çª„Éº„Ç∏
        const actionMessages = [
            "„Åä„Å®„Äú„Åµ„ÅØpixiv„ÇíÁú∫„ÇÅ„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØTwitter„ÅÆ„Çø„Ç§„É†„É©„Ç§„É≥„Çí„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØBLÊº´Áîª„ÇíË™≠„Çì„Åß„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÁµµ„ÇíÊèè„ÅÑ„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÁ≠ãËÇâ„ÅÆÊèè„ÅçÊñπÂãïÁîª„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Çπ„Éö„Éº„Çπ„ÇíËÅ¥„ÅÑ„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÁ≠ãËÇâ„ÇíÊèè„ÅÑ„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Å°„ÅÑ„Åã„Çè„ÅÆÂãïÁîª„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Éú„É≥„Éê„Éº„Åï„Çì„ÅÆÁµµ„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Ç®„É≥„Éö„É©Êßò„ÅÆÂãïÁîª„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Éè„Çπ„Ç≠„Éº„ÅÆÂ≠êÁä¨ÂãïÁîª„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÁãºÁä¨„ÅÆÂãïÁîª„ÅßÁôí„Åï„Çå„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØË§êËâ≤ËÇå„ÅÆÂ°ó„ÇäÊñπ„ÇíÁ†îÁ©∂„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Ç≥„É≥„Éà„É©„Éù„Çπ„Éà„ÇíÂãâÂº∑„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÁµµÊüÑÂàÜÊûê„Çí„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØÈçµÂû¢„ÅßÂºïÁî®„ÉÑ„Ç§„Éº„Éà„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØ„Éà„É©„Ç§„Éê„É´„Çø„Éà„Ç•„Éº„ÅÆË≥áÊñô„ÇíÈõÜ„ÇÅ„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØËÖπÁ≠ã„ÅÆÊèè„ÅçÊñπ„ÇíÁ∑¥Áøí„Åó„Å¶„ÅÑ„Çã‚Ä¶",
            "„Åä„Å®„Äú„Åµ„ÅØËÑá„ÅÆË≥áÊñô„ÇíË¶ã„Å¶„ÅÑ„Çã‚Ä¶"
        ];
        
        function updateActionMessage() {
            const message = actionMessages[Math.floor(Math.random() * actionMessages.length)];
            statusInfo.textContent = message;
        }
        
        // „Çª„É™„ÉïË°®Á§∫
        let dialogueTimer = null;
        
        function showDialogue(text, isCommand = false, isPixiv = false) {
            if (dialogueTimer) {
                clearTimeout(dialogueTimer);
            }
            
            speechText.textContent = text;
            
            if (isPixiv) {
                // pixivÂ∞ÇÁî®„ÅÆ„Éî„É≥„ÇØËâ≤
                speechBubble.style.background = '#FFB3D9';
                const style = document.createElement('style');
                style.id = 'speech-arrow-yellow';
                const old = document.getElementById('speech-arrow-yellow');
                if (old) old.remove();
                style.textContent = `#speech-bubble::before { border-color: transparent transparent #FFB3D9 transparent !important; }`;
                document.head.appendChild(style);
            } else if (isCommand) {
                speechBubble.style.background = '#FFF9C4';
                const style = document.createElement('style');
                style.id = 'speech-arrow-yellow';
                const old = document.getElementById('speech-arrow-yellow');
                if (old) old.remove();
                style.textContent = `#speech-bubble::before { border-color: transparent transparent #FFF9C4 transparent !important; }`;
                document.head.appendChild(style);
            } else {
                speechBubble.style.background = 'white';
                const style = document.createElement('style');
                style.id = 'speech-arrow-yellow';
                const old = document.getElementById('speech-arrow-yellow');
                if (old) old.remove();
                style.textContent = `#speech-bubble::before { border-color: transparent transparent white transparent !important; }`;
                document.head.appendChild(style);
            }
            
            speechBubble.classList.add('show');
            
            dialogueTimer = setTimeout(() => {
                speechBubble.classList.remove('show');
                dialogueTimer = null;
            }, 5000);
        }
        
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Çø„ÉÉ„Éó
        character.addEventListener('click', () => {
            const now = Date.now();
            if (isAnimating || now - lastCommandTime < commandCooldown) return;
            lastCommandTime = now;
            isAnimating = true;
            
            playCharacterSound();
            
            const random = Math.random();
            if (random < 0.4) {
                character.classList.add('jumping');
                setTimeout(() => {
                    character.classList.remove('jumping');
                    isAnimating = false;
                }, 600);
            } else {
                isAnimating = false;
            }
            
            const dialogue = getRandomDialogue();
            showDialogue(dialogue);
            addExperience(5);
            missionProgress.talkCount++;
            dailyMissionProgress.dailyTalkCount++;
            lastInteraction = Date.now();
            saveGameData();
        });
        
        // pixiv„Éú„Çø„É≥
        document.getElementById('pixiv-btn').addEventListener('click', () => {
            const now = Date.now();
            if (now - lastCommandTime < commandCooldown) return;
            if (collectedStars >= 3) {
                lastCommandTime = now;
                playActionSound();
                collectedStars -= 3;
                updateStarCounter();
                missionProgress.pixivCount++;
                dailyMissionProgress.dailyPixivCount++;
                saveGameData();
                addExperience(25);
                const dialogue = Math.random() < 0.7 ? getPixivDialogue() : pixivDialogues[Math.floor(Math.random() * pixivDialogues.length)];
                showDialogue(dialogue, true, true);
            }
        });
        
        // Ë§í„ÇÅ„Çã„Éú„Çø„É≥
        
        // „Éü„ÉÉ„Ç∑„Éß„É≥„Éú„Çø„É≥
        document.getElementById('mission-btn').addEventListener('click', () => {
            openMissionModal();
        });
        
        closeMissionBtn.addEventListener('click', () => {
            missionModal.classList.remove('show');
        });
        
        missionModal.addEventListener('click', (e) => {
            if (e.target === missionModal) {
                missionModal.classList.remove('show');
            }
        });
        
        function openMissionModal() {
            missionModal.classList.add('show');
            updateMissionList();
        }
        
        function updateMissionList() {
            missionList.innerHTML = '';
            
            // ÈÄöÂ∏∏„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂàÜÈ°û
            const claimableMissions = [];
            const inProgressMissions = [];
            
            missions.forEach(mission => {
                let currentProgress = 0;
                if (mission.type === 'talk') {
                    currentProgress = missionProgress.talkCount;
                } else if (mission.type === 'pixiv') {
                    currentProgress = missionProgress.pixivCount;
                } else if (mission.type === 'rank') {
                    currentProgress = rank;
                }
                
                const isCompleted = currentProgress >= mission.target;
                const isClaimed = claimedMissions.includes(mission.id);
                
                // ÈÅîÊàêÊ∏à„Åø„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                if (isClaimed) {
                    return;
                }
                
                // Âèó„ÅëÂèñ„ÇäÂèØËÉΩ„Å®ÈÄ≤Ë°å‰∏≠„Å´ÂàÜÈ°û
                if (isCompleted) {
                    claimableMissions.push({ mission, currentProgress, isDaily: false });
                } else {
                    inProgressMissions.push({ mission, currentProgress, isDaily: false });
                }
            });
            
            // „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂàÜÈ°û
            const claimableDailyMissions = [];
            const inProgressDailyMissions = [];
            
            dailyMissions.forEach(mission => {
                let currentProgress = 0;
                if (mission.type === 'dailyTalk') {
                    currentProgress = dailyMissionProgress.dailyTalkCount;
                } else if (mission.type === 'dailyPixiv') {
                    currentProgress = dailyMissionProgress.dailyPixivCount;
                } else if (mission.type === 'openGacha') {
                    currentProgress = dailyMissionProgress.openedGacha ? 1 : 0;
                } else if (mission.type === 'changeDecor') {
                    currentProgress = dailyMissionProgress.changedDecor ? 1 : 0;
                }
                
                const isCompleted = currentProgress >= mission.target;
                const isClaimed = claimedMissions.includes(mission.id);
                
                // Âèó„ÅëÂèñ„ÇäÊ∏à„Åø„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                if (isClaimed) {
                    return;
                }
                
                // Âèó„ÅëÂèñ„ÇäÂèØËÉΩ„Å®ÈÄ≤Ë°å‰∏≠„Å´ÂàÜÈ°û
                if (isCompleted) {
                    claimableDailyMissions.push({ mission, currentProgress, isDaily: true });
                } else {
                    inProgressDailyMissions.push({ mission, currentProgress, isDaily: true });
                }
            });
            
            // Ë°®Á§∫È†Ü: Âèó„ÅëÂèñ„ÇäÂèØËÉΩ„Å™ÈÄöÂ∏∏„Éü„ÉÉ„Ç∑„Éß„É≥ ‚Üí Âèó„ÅëÂèñ„ÇäÂèØËÉΩ„Å™„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ ‚Üí ÈÄ≤Ë°å‰∏≠„ÅÆ„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ ‚Üí ÈÄ≤Ë°å‰∏≠„ÅÆÈÄöÂ∏∏„Éü„ÉÉ„Ç∑„Éß„É≥
            [...claimableMissions, ...claimableDailyMissions, ...inProgressDailyMissions, ...inProgressMissions].forEach(({ mission, currentProgress, isDaily }) => {
                const missionItem = document.createElement('div');
                missionItem.className = 'mission-item';
                if (isDaily) {
                    missionItem.classList.add('daily');
                }
                
                const isCompleted = currentProgress >= mission.target;
                
                const rewardIcon = mission.rewardType === 'diamond' ? 'üíé' : '‚≠êÔ∏è';
                
                missionItem.innerHTML = `
                    <div class="mission-title">${isDaily ? 'üìÖ ' : ''}${mission.name}</div>
                    <div class="mission-progress">ÈÄ≤Êçó: ${Math.min(currentProgress, mission.target)}/${mission.target}</div>
                    <div class="mission-reward">Â†±ÈÖ¨: ${rewardIcon} √ó ${mission.reward}</div>
                `;
                
                if (isCompleted) {
                    const claimBtn = document.createElement('button');
                    claimBtn.className = 'mission-claim-btn';
                    claimBtn.textContent = 'Â†±ÈÖ¨„ÇíÂèó„ÅëÂèñ„Çã';
                    claimBtn.addEventListener('click', () => {
                        claimMissionReward(mission);
                    });
                    missionItem.appendChild(claimBtn);
                }
                
                missionList.appendChild(missionItem);
            });
            
            // ÂÖ®„Å¶ÈÅîÊàêÊ∏à„Åø„ÅÆÂ†¥Âêà
            if (claimableMissions.length === 0 && claimableDailyMissions.length === 0 && inProgressMissions.length === 0 && inProgressDailyMissions.length === 0) {
                missionList.innerHTML = '<div style="text-align:center; color:white; padding:20px;">ÂÖ®„Å¶„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅüéâ</div>';
            }
        }
        
        function claimMissionReward(mission) {
            if (mission.rewardType === 'diamond') {
                // „ÉÄ„Ç§„É§Â†±ÈÖ¨
                collectedDiamonds = Math.min(collectedDiamonds + mission.reward, maxDiamonds);
                updateDiamondCounter();
            } else {
                // ÊòüÂ†±ÈÖ¨
                collectedStars = Math.min(collectedStars + mission.reward, maxStars);
                updateStarCounter();
            }
            claimedMissions.push(mission.id);
            saveGameData();
            updateMissionList();
            playStarSound();
        }
        
        // „É©„É≥„ÇØË°®Á§∫„Çí„Çø„ÉÉ„Éó„Åó„Å¶„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        rankDisplay.addEventListener('click', (e) => {
            e.stopPropagation();
            openRankModal();
        });
        
        // „É¶„Éº„Ç∂„Éº„Éç„Éº„É†Ë°®Á§∫„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        usernameText.addEventListener('click', (e) => {
            e.stopPropagation();
            usernameInput.value = username === 'ÂêçÂâç„ÇíÂÖ•Âäõ' ? '' : username;
            updateCharCount();
            usernameModal.classList.add('show');
            setTimeout(() => usernameInput.focus(), 100);
        });
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeModalBtn.addEventListener('click', () => {
            rankModal.classList.remove('show');
        });
        
        // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÇÇÈñâ„Åò„Çã
        rankModal.addEventListener('click', (e) => {
            if (e.target === rankModal) {
                rankModal.classList.remove('show');
            }
        });
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openRankModal() {
            rankModal.classList.add('show');
            updateRewardItems();
        }
        
        // Â†±ÈÖ¨„Ç¢„Ç§„ÉÜ„É†„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateRewardItems() {
            const rewardItems = document.querySelectorAll('.reward-item');
            
            rewardItems.forEach(item => {
                const requiredRank = parseInt(item.dataset.rank);
                const type = item.dataset.type;
                const value = item.dataset.value;
                
                // „É≠„ÉÉ„ÇØËß£Èô§Âà§ÂÆö
                if (rank >= requiredRank) {
                    item.classList.remove('locked');
                    const lockText = item.querySelector('.reward-locked');
                    if (lockText) {
                        lockText.className = 'reward-unlock';
                        lockText.textContent = 'Ëß£Á¶ÅÊ∏à„Åø';
                    }
                    
                    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                    item.onclick = () => {
                        if (type === 'character') {
                            currentCharacter = value;
                            character.textContent = value;
                            // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                            document.querySelectorAll('[data-type="character"]').forEach(el => {
                                el.classList.remove('active');
                            });
                            item.classList.add('active');
                        } else if (type === 'background') {
                            currentBackground = value;
                            document.body.className = value + '-bg';
                            generateBackgroundEffect(value);
                            // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                            document.querySelectorAll('[data-type="background"]').forEach(el => {
                                el.classList.remove('active');
                            });
                            item.classList.add('active');
                        }
                        saveGameData();
                    };
                } else {
                    item.classList.add('locked');
                    item.onclick = null;
                }
                
                // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                if (type === 'character' && value === currentCharacter) {
                    item.classList.add('active');
                } else if (type === 'background' && value === currentBackground) {
                    item.classList.add('active');
                } else if (type === item.dataset.type) {
                    item.classList.remove('active');
                }
            });
        }
        
        // „Ç¨„ÉÅ„É£„Éú„Çø„É≥
        document.getElementById('gacha-btn').addEventListener('click', () => {
            gachaModal.classList.add('show');
            gachaResult.innerHTML = '';
            dailyMissionProgress.openedGacha = true;
            saveGameData();
            updateGachaPullButton();
        });
        
        // Êòü„Ç¨„ÉÅ„É£„ÇíÂºï„Åè
        gachaPullBtnStar.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (collectedStars < 10) return;
            
            collectedStars -= 10;
            updateStarCounter();
            saveGameData();
            
            // „Ç¨„ÉÅ„É£ÊºîÂá∫
            gachaResult.innerHTML = '<div class="gacha-result-text">„Ç¨„ÉÅ„É£‰∏≠...</div>';
            
            setTimeout(() => {
                try {
                    const result = pullGacha();
                    displayGachaResult(result);
                } catch (error) {
                    console.error('„Ç¨„ÉÅ„É£„Ç®„É©„Éº:', error);
                    gachaResult.innerHTML = '<div class="gacha-result-text">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
                    // Êòü„ÇíËøîÂç¥
                    collectedStars += 10;
                    updateStarCounter();
                    saveGameData();
                }
            }, 1000);
        });
        
        // „ÉÄ„Ç§„É§„Ç¨„ÉÅ„É£„ÇíÂºï„Åè
        gachaPullBtnDiamond.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (collectedDiamonds < 1) return;
            
            collectedDiamonds -= 1;
            updateDiamondCounter();
            saveGameData();
            
            // „Ç¨„ÉÅ„É£ÊºîÂá∫
            gachaResult.innerHTML = '<div class="gacha-result-text">‚ú® SSR„Ç¨„ÉÅ„É£‰∏≠... ‚ú®</div>';
            
            setTimeout(() => {
                try {
                    const result = pullDiamondGacha();
                    displayGachaResult(result);
                } catch (error) {
                    console.error('„Ç¨„ÉÅ„É£„Ç®„É©„Éº:', error);
                    gachaResult.innerHTML = '<div class="gacha-result-text">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
                    // „ÉÄ„Ç§„É§„ÇíËøîÂç¥
                    collectedDiamonds += 1;
                    updateDiamondCounter();
                    saveGameData();
                }
            }, 1000);
        });
        
        // „Ç¨„ÉÅ„É£„ÇíÂºï„ÅèÂá¶ÁêÜÔºàÂÆåÂÖ®Ë¢´„ÇäÈò≤Ê≠¢ÁâàÔºâ
        function pullGacha() {
            let item;
            let type;

            function pickFrom(list){ return list[Math.floor(Math.random() * list.length)]; }
            
            function isOwned(t, it){
                if (!it) return false;
                if (t === 'character') return unlockedCharacters.includes(it.emoji);
                if (t === 'background') return unlockedBackgrounds.includes(it.id);
                if (t === 'decor') return !!ownedDecor[it.emoji];
                return false;
            }

            // „Åæ„ÅöÊú™ÊâÄÊåÅ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí„Åô„Åπ„Å¶ÈõÜ„ÇÅ„Çã
            const unownedCharacters = gachaCharacters.filter(c => !unlockedCharacters.includes(c.emoji));
            const unownedBackgrounds = gachaBackgrounds.filter(b => !unlockedBackgrounds.includes(b.id));
            const unownedDecors = gachaDecors.filter(d => !ownedDecor[d.emoji]);

            // „Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éó„Éº„É´
            const allUnowned = [
                ...unownedCharacters.map(c => ({ type: 'character', item: c })),
                ...unownedBackgrounds.map(b => ({ type: 'background', item: b })),
                ...unownedDecors.map(d => ({ type: 'decor', item: d }))
            ];

            // Êú™ÊâÄÊåÅ„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊú™ÊâÄÊåÅ„Åã„ÇâÈÅ∏„Å∂
            if (allUnowned.length > 0) {
                // „É¨„Ç¢„É™„ÉÜ„Ç£„Åî„Å®„ÅÆÁ¢∫Áéá„ÅßÊäΩÈÅ∏
                const random = Math.random() * 100;
                let targetRarity;
                if (random < 45) targetRarity = 'common';        // 45%
                else if (random < 75) targetRarity = 'rare';     // 30%
                else if (random < 97) targetRarity = 'sr';       // 22%
                else targetRarity = 'ssr';                       // 3%

                // ÊåáÂÆö„É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆÊú™ÊâÄÊåÅ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
                let filteredUnowned = allUnowned.filter(x => x.item.rarity === targetRarity);
                
                // ÊåáÂÆö„É¨„Ç¢„É™„ÉÜ„Ç£„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊ¨°„ÅÆ„É¨„Ç¢„É™„ÉÜ„Ç£„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                if (filteredUnowned.length === 0) {
                    const rarityOrder = ['ssr', 'sr', 'rare', 'common'];
                    const startIdx = rarityOrder.indexOf(targetRarity);
                    for (let i = startIdx + 1; i < rarityOrder.length; i++) {
                        filteredUnowned = allUnowned.filter(x => x.item.rarity === rarityOrder[i]);
                        if (filteredUnowned.length > 0) break;
                    }
                }
                
                // „Åù„Çå„Åß„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®Êú™ÊâÄÊåÅ„Åã„Çâ„É©„É≥„ÉÄ„É†
                if (filteredUnowned.length === 0) {
                    filteredUnowned = allUnowned;
                }

                const selected = pickFrom(filteredUnowned);
                type = selected.type;
                item = selected.item;
            } else {
                // ÂÖ®ÈÉ®ÊâÄÊåÅÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„É©„É≥„ÉÄ„É†ÊäΩÈÅ∏
                const random = Math.random() * 100;
                let rarity;
                if (random < 45) rarity = 'common';        // 45%
                else if (random < 75) rarity = 'rare';     // 30%
                else if (random < 97) rarity = 'sr';       // 22%
                else rarity = 'ssr';                       // 3%

                const roll = Math.random();
                if (roll < 0.4) type = 'character';
                else if (roll < 0.7) type = 'background';
                else type = 'decor';

                let list = [];
                if (type === 'character') {
                    list = gachaCharacters.filter(c => c.rarity === rarity);
                    if (list.length === 0) list = gachaCharacters;
                } else if (type === 'background') {
                    list = gachaBackgrounds.filter(b => b.rarity === rarity);
                    if (list.length === 0) list = gachaBackgrounds;
                } else {
                    list = gachaDecors.filter(d => d.rarity === rarity);
                    if (list.length === 0) list = gachaDecors;
                }

                item = pickFrom(list);
            }

            const wasOwned = isOwned(type, item);

            // „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´ËøΩÂä†
            if (type === 'character') {
                if (!unlockedCharacters.includes(item.emoji)) {
                    unlockedCharacters.push(item.emoji);
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            } else if (type === 'background') {
                if (!unlockedBackgrounds.includes(item.id)) {
                    unlockedBackgrounds.push(item.id);
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            } else if (type === 'decor') {
                if (!ownedDecor[item.emoji]) {
                    ownedDecor[item.emoji] = item.name;
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            }

            return { type: type, item: item, isNew: false };
        }
        
        // „ÉÄ„Ç§„É§„Ç¨„ÉÅ„É£ÔºàSSRÁ¢∫ÂÆöÔºâ
        function pullDiamondGacha() {
            let item;
            let type;

            function pickFrom(list){ return list[Math.floor(Math.random() * list.length)]; }
            
            // SSR„ÅÆ„Åø„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÈõÜ„ÇÅ„Çã
            const ssrCharacters = gachaCharacters.filter(c => c.rarity === 'ssr');
            const ssrBackgrounds = gachaBackgrounds.filter(b => b.rarity === 'ssr');
            const ssrDecors = gachaDecors.filter(d => d.rarity === 'ssr');
            
            // Êú™ÊâÄÊåÅ„ÅÆSSR„ÇíÂÑ™ÂÖà
            const unownedSSRCharacters = ssrCharacters.filter(c => !unlockedCharacters.includes(c.emoji));
            const unownedSSRBackgrounds = ssrBackgrounds.filter(b => !unlockedBackgrounds.includes(b.id));
            const unownedSSRDecors = ssrDecors.filter(d => !ownedDecor[d.emoji]);
            
            const allUnownedSSR = [
                ...unownedSSRCharacters.map(c => ({ type: 'character', item: c })),
                ...unownedSSRBackgrounds.map(b => ({ type: 'background', item: b })),
                ...unownedSSRDecors.map(d => ({ type: 'decor', item: d }))
            ];
            
            // Êú™ÊâÄÊåÅSSR„Åå„ÅÇ„Çå„Å∞„Åù„Åì„Åã„ÇâÈÅ∏„Å∂
            if (allUnownedSSR.length > 0) {
                const selected = pickFrom(allUnownedSSR);
                type = selected.type;
                item = selected.item;
            } else {
                // ÂÖ®SSRÊâÄÊåÅÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÂÖ®SSR„Åã„Çâ„É©„É≥„ÉÄ„É†
                const allSSR = [
                    ...ssrCharacters.map(c => ({ type: 'character', item: c })),
                    ...ssrBackgrounds.map(b => ({ type: 'background', item: b })),
                    ...ssrDecors.map(d => ({ type: 'decor', item: d }))
                ];
                
                if (allSSR.length > 0) {
                    const selected = pickFrom(allSSR);
                    type = selected.type;
                    item = selected.item;
                } else {
                    // SSR„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
                    return pullGacha();
                }
            }
            
            const wasOwned = (type === 'character' && unlockedCharacters.includes(item.emoji)) ||
                           (type === 'background' && unlockedBackgrounds.includes(item.id)) ||
                           (type === 'decor' && ownedDecor[item.emoji]);

            if (type === 'character') {
                if (!unlockedCharacters.includes(item.emoji)) {
                    unlockedCharacters.push(item.emoji);
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            } else if (type === 'background') {
                if (!unlockedBackgrounds.includes(item.id)) {
                    unlockedBackgrounds.push(item.id);
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            } else if (type === 'decor') {
                if (!ownedDecor[item.emoji]) {
                    ownedDecor[item.emoji] = item.name;
                }
                saveGameData();
                return { type: type, item: item, isNew: !wasOwned };
            }

            return { type: type, item: item, isNew: false };
        }
        
        // „Ç¨„ÉÅ„É£ÂäπÊûúÈü≥
        function playGachaSound(rarity) {
            // ÂäπÊûúÈü≥„Åå0%„ÅÆÂ†¥Âêà„ÅØÂÜçÁîü„Åó„Å™„ÅÑ
            if (seVolume <= 0) {
                return;
            }
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // AudioContext„Ååsuspended„ÅÆÂ†¥Âêà„ÅØresume
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        playGachaSoundInternal(audioContext, rarity);
                    });
                } else {
                    playGachaSoundInternal(audioContext, rarity);
                }
            } catch (error) {
                // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÈü≥„ÅåÈ≥¥„Çâ„Å™„ÅÑ„Å†„ÅëÔºâ
            }
        }
        
        function playGachaSoundInternal(audioContext, rarity) {
            const now = audioContext.currentTime;
            
            // seVolume„Åå0„ÅÆÂ†¥Âêà„Åß„ÇÇ„Ç®„É©„Éº„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´ÊúÄÂ∞èÂÄ§„Çí‰øùË®º
            const minVolume = 0.001;
            const effectiveSeVolume = Math.max(seVolume, 0.001);
            
            if (rarity === 'ssr') {
                    // SSR: Rare„ÅÆÈü≥„ÇíÈ´ò„Åè„Åó„Åü2Èü≥
                    const frequencies = [392.00, 493.88]; // G4, B4
                    frequencies.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq, now);
                        
                        gain.gain.setValueAtTime(0, now);
                        gain.gain.linearRampToValueAtTime(0.25 * effectiveSeVolume, now + 0.05);
                        gain.gain.exponentialRampToValueAtTime(Math.max(0.02 * effectiveSeVolume, minVolume), now + 0.5);
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.start(now + i * 0.1);
                    osc.stop(now + 0.5);
                });
            } else if (rarity === 'sr') {
                // SR: Rare„Å®SSR„ÅÆ‰∏≠Èñì„ÅÆ2Èü≥
                const frequencies = [329.63, 415.30]; // E4, G#4
                frequencies.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now);
                    
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.22 * effectiveSeVolume, now + 0.05);
                    gain.gain.exponentialRampToValueAtTime(Math.max(0.02 * effectiveSeVolume, minVolume), now + 0.45);
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.start(now + i * 0.1);
                    osc.stop(now + 0.45);
                });
            } else if (rarity === 'rare') {
                // Rare: „Ç∑„É≥„Éó„É´„Å™‰∏äÊòáÈü≥
                const frequencies = [261.63, 329.63]; // C4, E4
                frequencies.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now);
                    
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.2 * effectiveSeVolume, now + 0.05);
                    gain.gain.exponentialRampToValueAtTime(Math.max(0.02 * effectiveSeVolume, minVolume), now + 0.4);
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    
                    osc.start(now + i * 0.1);
                    osc.stop(now + 0.4);
                });
            } else {
                // Common: Áü≠„ÅÑ„Éù„ÉÉ„ÉóÈü≥
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(261.63, now); // C4
                
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.16 * effectiveSeVolume, now + 0.05);
                gain.gain.exponentialRampToValueAtTime(Math.max(0.02 * effectiveSeVolume, minVolume), now + 0.3);
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }
        
        // „Ç¨„ÉÅ„É£ÁµêÊûúË°®Á§∫
        function displayGachaResult(result) {
            if (!result || !result.item) {
                gachaResult.innerHTML = '<div class="gacha-result-text">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
                return;
            }
            
            const rarityNames = {
                common: '„Ç≥„É¢„É≥',
                rare: '„É¨„Ç¢',
                sr: 'SR',
                ssr: 'SSR'
            };
            
            const typeNames = {
                character: '„Ç≠„É£„É©„ÇØ„Çø„Éº',
                background: 'ËÉåÊôØ',
                decor: 'È£æ„Çä'
            };
            
            const icon = result.type === 'character' ? result.item.emoji : result.item.emoji;
            const name = result.item.name || '???';
            const rarity = rarityNames[result.item.rarity] || '„Ç≥„É¢„É≥';
            const type = typeNames[result.type] || '';
            
            gachaResult.innerHTML = `
                <div class="gacha-result-icon">${icon}</div>
                <div class="gacha-result-text">${name}</div>
                <div class="gacha-result-meta">
                    <div class="gacha-rarity rarity-${result.item.rarity}">${rarity}</div>
                    <div class="gacha-result-type">${type}</div>
                </div>
            `;
            
            // ÂäπÊûúÈü≥„ÇíÂÜçÁîü
            playGachaSound(result.item.rarity);
            
            updateGachaPullButton();
        }
        
        // „Ç¨„ÉÅ„É£„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
        function updateGachaPullButton() {
            // Êòü„Ç¨„ÉÅ„É£„Éú„Çø„É≥
            if (collectedStars >= 10) {
                gachaPullBtnStar.disabled = false;
            } else {
                gachaPullBtnStar.disabled = true;
            }
            
            // „ÉÄ„Ç§„É§„Ç¨„ÉÅ„É£„Éú„Çø„É≥
            if (collectedDiamonds >= 1) {
                gachaPullBtnDiamond.disabled = false;
            } else {
                gachaPullBtnDiamond.disabled = true;
            }
        }
        
        // „Ç¨„ÉÅ„É£„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeGachaBtn.addEventListener('click', () => {
            gachaModal.classList.remove('show');
        });
        
        gachaModal.addEventListener('click', (e) => {
            if (e.target === gachaModal) {
                gachaModal.classList.remove('show');
            }
        });
        
        // ÁùÄ„ÅõÊõø„Åà„Éú„Çø„É≥
        document.getElementById('closet-btn').addEventListener('click', () => {
            openClosetModal();
        });
        
        // ÁùÄ„ÅõÊõø„Åà„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openClosetModal() {
            closetModal.classList.add('show');
            updateClosetItems();
        }
        
        // ÁùÄ„ÅõÊõø„Åà„Ç¢„Ç§„ÉÜ„É†Ë°®Á§∫
        function updateClosetItems() {
            const charactersGrid = document.getElementById('closet-characters');
            const backgroundsGrid = document.getElementById('closet-backgrounds');
            
            // „Ç≠„É£„É©„ÇØ„Çø„ÉºË°®Á§∫
            charactersGrid.innerHTML = '';
            
            // „Éá„Éï„Ç©„É´„Éà„ÅÆüåö
            const defaultChar = document.createElement('div');
            defaultChar.className = 'reward-item';
            if (currentCharacter === 'üåö') defaultChar.classList.add('active');
            defaultChar.innerHTML = `
                <div class="reward-icon">üåö</div>
                <div class="reward-name">„Åä„Å®„Äú„Åµ</div>
                <div class="reward-unlock">„Éá„Éï„Ç©„É´„Éà</div>
            `;
            defaultChar.onclick = () => {
                currentCharacter = 'üåö';
                character.textContent = 'üåö';
                updateExistingStars();
                saveGameData();
                updateClosetItems();
            };
            charactersGrid.appendChild(defaultChar);
            
            // „É©„É≥„ÇØÂ†±ÈÖ¨„Ç≠„É£„É©„ÇØ„Çø„Éº
            // üêµ „Çµ„É´ (Rank 5)
            const monkeyChar = document.createElement('div');
            monkeyChar.className = 'reward-item';
            if (rank >= 5) {
                if (currentCharacter === 'üêµ') monkeyChar.classList.add('active');
                monkeyChar.innerHTML = `
                    <div class="reward-icon">üêµ</div>
                    <div class="reward-name">„Çµ„É´</div>
                    <div class="reward-unlock">„É©„É≥„ÇØÂ†±ÈÖ¨</div>
                `;
                monkeyChar.onclick = () => {
                    currentCharacter = 'üêµ';
                    character.textContent = 'üêµ';
                    updateExistingStars();
                    saveGameData();
                    updateClosetItems();
                };
            } else {
                monkeyChar.classList.add('locked');
                monkeyChar.innerHTML = `
                    <div class="reward-icon">üêµ</div>
                    <div class="reward-name">„Çµ„É´</div>
                    <div class="reward-locked">Rank 5„ÅßËß£Á¶Å</div>
                `;
            }
            charactersGrid.appendChild(monkeyChar);
            
            // ü§° „Éî„Ç®„É≠ (Rank 10)
            const clownChar = document.createElement('div');
            clownChar.className = 'reward-item';
            if (rank >= 10) {
                if (currentCharacter === 'ü§°') clownChar.classList.add('active');
                clownChar.innerHTML = `
                    <div class="reward-icon">ü§°</div>
                    <div class="reward-name">„Éî„Ç®„É≠</div>
                    <div class="reward-unlock">„É©„É≥„ÇØÂ†±ÈÖ¨</div>
                `;
                clownChar.onclick = () => {
                    currentCharacter = 'ü§°';
                    character.textContent = 'ü§°';
                    updateExistingStars();
                    saveGameData();
                    updateClosetItems();
                };
            } else {
                clownChar.classList.add('locked');
                clownChar.innerHTML = `
                    <div class="reward-icon">ü§°</div>
                    <div class="reward-name">„Éî„Ç®„É≠</div>
                    <div class="reward-locked">Rank 10„ÅßËß£Á¶Å</div>
                `;
            }
            charactersGrid.appendChild(clownChar);
            
            // üåù „É†„Éº„É≥ (Rank 20)
            const moonFaceChar = document.createElement('div');
            moonFaceChar.className = 'reward-item';
            if (rank >= 20) {
                if (currentCharacter === 'üåù') moonFaceChar.classList.add('active');
                moonFaceChar.innerHTML = `
                    <div class="reward-icon">üåù</div>
                    <div class="reward-name">„É†„Éº„É≥</div>
                    <div class="reward-unlock">„É©„É≥„ÇØÂ†±ÈÖ¨</div>
                `;
                moonFaceChar.onclick = () => {
                    currentCharacter = 'üåù';
                    character.textContent = 'üåù';
                    updateExistingStars();
                    saveGameData();
                    updateClosetItems();
                };
            } else {
                moonFaceChar.classList.add('locked');
                moonFaceChar.innerHTML = `
                    <div class="reward-icon">üåù</div>
                    <div class="reward-name">„É†„Éº„É≥</div>
                    <div class="reward-locked">Rank 20„ÅßËß£Á¶Å</div>
                `;
            }
            charactersGrid.appendChild(moonFaceChar);
            
            // „Ç¨„ÉÅ„É£„Ç≠„É£„É©„ÇØ„Çø„Éº
            gachaCharacters.forEach(char => {
                const item = document.createElement('div');
                item.className = 'reward-item';
                
                if (unlockedCharacters.includes(char.emoji)) {
                    if (currentCharacter === char.emoji) item.classList.add('active');
                    item.innerHTML = `
                        <div class="reward-icon">${char.emoji}</div>
                        <div class="reward-name">${char.name}</div>
                        <div class="reward-unlock">ÊâÄÊåÅ</div>
                    `;
                    item.onclick = () => {
                        currentCharacter = char.emoji;
                        character.textContent = char.emoji;
                        updateExistingStars();
                        saveGameData();
                        updateClosetItems();
                    };
                } else {
                    item.classList.add('locked');
                    item.innerHTML = `
                        <div class="reward-icon">‚ùì</div>
                        <div class="reward-name">???</div>
                        <div class="reward-locked">Êú™ÊâÄÊåÅ</div>
                    `;
                }
                
                charactersGrid.appendChild(item);
            });
            
            // ËÉåÊôØË°®Á§∫
            backgroundsGrid.innerHTML = '';
            
            // „Éá„Éï„Ç©„É´„Éà„ÅÆÂ§úÁ©∫
            const defaultBg = document.createElement('div');
            defaultBg.className = 'reward-item';
            if (currentBackground === 'night') defaultBg.classList.add('active');
            defaultBg.innerHTML = `
                <div class="reward-icon">üåô</div>
                <div class="reward-name">Â§úÁ©∫</div>
                <div class="reward-unlock">„Éá„Éï„Ç©„É´„Éà</div>
            `;
            defaultBg.onclick = () => {
                currentBackground = 'night';
                document.body.className = 'night-bg';
                generateBackgroundEffect('night');
                saveGameData();
                updateClosetItems();
            };
            backgroundsGrid.appendChild(defaultBg);
            
            // „É©„É≥„ÇØÂ†±ÈÖ¨„ÅÆÂ§ïÊöÆ„Çå (Rank 15)
            const cityBg = document.createElement('div');
            cityBg.className = 'reward-item';
            if (rank >= 15) {
                if (currentBackground === 'city') cityBg.classList.add('active');
                cityBg.innerHTML = `
                    <div class="reward-icon">üåÜ</div>
                    <div class="reward-name">Â§ïÊöÆ„Çå</div>
                    <div class="reward-unlock">„É©„É≥„ÇØÂ†±ÈÖ¨</div>
                `;
                cityBg.onclick = () => {
                    currentBackground = 'city';
                    document.body.className = 'city-bg';
                    generateBackgroundEffect('city');
                    saveGameData();
                    updateClosetItems();
                };
            } else {
                cityBg.classList.add('locked');
                cityBg.innerHTML = `
                    <div class="reward-icon">üåÜ</div>
                    <div class="reward-name">Â§ïÊöÆ„Çå</div>
                    <div class="reward-locked">Rank 15„ÅßËß£Á¶Å</div>
                `;
            }
            backgroundsGrid.appendChild(cityBg);
            
            // „É©„É≥„ÇØÂ†±ÈÖ¨„ÅÆËôπ (Rank 20)
            const rainbowBg = document.createElement('div');
            rainbowBg.className = 'reward-item';
            if (rank >= 20) {
                if (currentBackground === 'rainbow') rainbowBg.classList.add('active');
                rainbowBg.innerHTML = `
                    <div class="reward-icon">üåà</div>
                    <div class="reward-name">Ëôπ</div>
                    <div class="reward-unlock">„É©„É≥„ÇØÂ†±ÈÖ¨</div>
                `;
                rainbowBg.onclick = () => {
                    currentBackground = 'rainbow';
                    document.body.className = 'rainbow-bg';
                    generateBackgroundEffect('rainbow');
                    saveGameData();
                    updateClosetItems();
                };
            } else {
                rainbowBg.classList.add('locked');
                rainbowBg.innerHTML = `
                    <div class="reward-icon">üåà</div>
                    <div class="reward-name">Ëôπ</div>
                    <div class="reward-locked">Rank 20„ÅßËß£Á¶Å</div>
                `;
            }
            backgroundsGrid.appendChild(rainbowBg);
            
            // „Ç¨„ÉÅ„É£ËÉåÊôØ
            gachaBackgrounds.forEach(bg => {
                const item = document.createElement('div');
                item.className = 'reward-item';
                
                if (unlockedBackgrounds.includes(bg.id)) {
                    if (currentBackground === bg.id) item.classList.add('active');
                    item.innerHTML = `
                        <div class="reward-icon">${bg.emoji}</div>
                        <div class="reward-name">${bg.name}</div>
                        <div class="reward-unlock">ÊâÄÊåÅ</div>
                    `;
                    item.onclick = () => {
                        currentBackground = bg.id;
                        document.body.className = bg.id + '-bg';
                        generateBackgroundEffect(bg.id);
                        saveGameData();
                        updateClosetItems();
                    };
                } else {
                    item.classList.add('locked');
                    item.innerHTML = `
                        <div class="reward-icon">‚ùì</div>
                        <div class="reward-name">???</div>
                        <div class="reward-locked">Êú™ÊâÄÊåÅ</div>
                    `;
                }
                
                backgroundsGrid.appendChild(item);
            });
            
            // È£æ„Çä„ÅÆË°®Á§∫
            const decorsGrid = document.getElementById('closet-decors');
            decorsGrid.innerHTML = '';
            
            // È£æ„Çä„Çπ„É≠„ÉÉ„Éà„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            let activeDecorSlot = 0;
            const slotBtns = document.querySelectorAll('.decor-slot-btn');
            slotBtns.forEach((btn, idx) => {
                // Ë£ÖÂÇô‰∏≠„ÅÆÈ£æ„Çä„ÇíË°®Á§∫
                const equipped = equippedDecor[idx];
                if (equipped) {
                    btn.textContent = `„Çπ„É≠„ÉÉ„Éà${idx + 1} ${equipped}`;
                    btn.style.background = 'rgba(255, 215, 0, 0.15)';
                } else {
                    btn.textContent = `„Çπ„É≠„ÉÉ„Éà${idx + 1}`;
                    btn.style.background = 'rgba(0,0,0,0.28)';
                }
                
                btn.onclick = () => {
                    slotBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeDecorSlot = idx;
                };
            });
            
            // ÊâÄÊåÅ„Åó„Å¶„ÅÑ„ÇãÈ£æ„Çä„ÇíË°®Á§∫
            Object.keys(ownedDecor).forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'decor-item-btn';
                btn.textContent = emoji;
                btn.title = ownedDecor[emoji];
                
                // Êó¢„Å´Ë£ÖÂÇô„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const isEquipped = equippedDecor.includes(emoji);
                if (isEquipped) {
                    btn.style.border = '3px solid #FFD700';
                    btn.style.background = 'rgba(255, 215, 0, 0.2)';
                    btn.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.5)';
                }
                
                btn.onclick = () => {
                    // Êó¢„Å´‰ªñ„ÅÆ„Çπ„É≠„ÉÉ„Éà„Å´Ë£ÖÂÇô„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const existingSlot = equippedDecor.indexOf(emoji);
                    if (existingSlot !== -1 && existingSlot !== activeDecorSlot) {
                        return;
                    }
                    
                    // Ë£ÖÂÇô
                    equippedDecor[activeDecorSlot] = emoji;
                    dailyMissionProgress.changedDecor = true;
                    saveGameData();
                    renderPlaceableDecor();
                    updateClosetItems(); // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                    
                    // Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                    btn.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        btn.style.transform = '';
                    }, 200);
                };
                decorsGrid.appendChild(btn);
            });
            
            // Á©∫„Å´„Åô„Çã„Éú„Çø„É≥
            if (Object.keys(ownedDecor).length > 0) {
                const emptyBtn = document.createElement('button');
                emptyBtn.className = 'decor-item-btn';
                emptyBtn.textContent = '‚ùå';
                emptyBtn.title = 'Â§ñ„Åô';
                emptyBtn.style.background = 'rgba(255, 100, 100, 0.2)';
                emptyBtn.style.border = '2px solid rgba(255, 100, 100, 0.5)';
                emptyBtn.onclick = () => {
                    equippedDecor[activeDecorSlot] = null;
                    decorPlacements[activeDecorSlot] = null;
                    saveGameData();
                    renderPlaceableDecor();
                    updateClosetItems(); // „Çπ„É≠„ÉÉ„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞
                    
                    // Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                    emptyBtn.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        emptyBtn.style.transform = '';
                    }, 200);
                };
                decorsGrid.appendChild(emptyBtn);
            }
            
            // È£æ„Çä„Åå„Å™„ÅÑÂ†¥Âêà
            if (Object.keys(ownedDecor).length === 0) {
                decorsGrid.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 20px;">„Ç¨„ÉÅ„É£„ÅßÈ£æ„Çä„Çí„Ç≤„ÉÉ„Éà„Åó„Çà„ÅÜÔºÅ</div>';
            }
        }
        
        // ÁùÄ„ÅõÊõø„Åà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeClosetBtn.addEventListener('click', () => {
            closetModal.classList.remove('show');
            renderPlaceableDecor();
        });
        
        closetModal.addEventListener('click', (e) => {
            if (e.target === closetModal) {
                closetModal.classList.remove('show');
                renderPlaceableDecor();
            }
        });
        
        // ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateCharCount() {
            const length = usernameInput.value.length;
            usernameCharCount.textContent = `${length} / 6`;
        }
        
        // ÂÖ•ÂäõÊôÇ„Å´ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        usernameInput.addEventListener('input', updateCharCount);
        
        // „É¶„Éº„Ç∂„Éº„Éç„Éº„É†‰øùÂ≠ò
        usernameSaveBtn.addEventListener('click', () => {
            const newUsername = usernameInput.value.trim();
            if (newUsername.length > 0 && newUsername.length <= 6) {
                username = newUsername;
                usernameText.textContent = username;
                saveGameData();
                usernameModal.classList.remove('show');
            } else if (newUsername.length === 0) {
                username = 'ÂêçÂâç„ÇíÂÖ•Âäõ';
                usernameText.textContent = username;
                saveGameData();
                usernameModal.classList.remove('show');
            } else {
                alert('„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÅØ6ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
        });
        
        // „Ç≠„É£„É≥„Çª„É´
        usernameCancelBtn.addEventListener('click', () => {
            usernameModal.classList.remove('show');
        });
        
        // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        usernameModal.addEventListener('click', (e) => {
            if (e.target === usernameModal) {
                usernameModal.classList.remove('show');
            }
        });
        
        // Enter„Ç≠„Éº„Åß‰øùÂ≠ò
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                usernameSaveBtn.click();
            }
        });
        
        
        // „Çª„Éº„ÉñË™≠ËæºÂæå„ÇÑ„Çª„Éº„ÉñÂºï„ÅçÁ∂ô„ÅéÂæå„Å´„ÄÅÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÁîªÈù¢„Å∏ÂèçÊò†„Åô„Çã
        function refreshUIFromState() {
            try {
                if (typeof usernameText !== 'undefined' && usernameText) {
                    usernameText.textContent = username || 'ÂêçÂâç„ÇíÂÖ•Âäõ';
                }
                if (typeof character !== 'undefined' && character) {
                    character.textContent = currentCharacter || 'üåö';
                }

                if (currentBackground) {
                    document.body.className = currentBackground + '-bg';
                    generateBackgroundEffect(currentBackground);
                }

                if (typeof updateStarCounter === 'function') updateStarCounter();
                if (typeof updateRankDisplay === 'function') updateRankDisplay();
                if (typeof updateActionMessage === 'function') updateActionMessage();
                if (typeof updateDiamondCounter === 'function') updateDiamondCounter();
                if (typeof updateMissionList === 'function') updateMissionList();
                if (typeof updateRewardItems === 'function') updateRewardItems();
                if (typeof updateGachaPullButton === 'function') updateGachaPullButton();
                if (typeof updateButtonStates === 'function') updateButtonStates();
                if (typeof updateClosetItems === 'function') updateClosetItems();
                if (typeof renderPlaceableDecor === 'function') renderPlaceableDecor();
                if (typeof updateExistingStars === 'function') updateExistingStars();
            } catch (e) {
                console.warn('refreshUIFromState failed', e);
            }
        }

// ÂàùÊúüÂåñ
        loadGameData();
        refreshUIFromState();
        
        // „Ç∑„É™„Ç¢„É´„Ç≥„Éº„ÉâÊ©üËÉΩÔºàÂàùÊúüÂåñÂæå„Å´Ë®≠ÂÆöÔºâ
        const serialInput = document.getElementById('serial-input');
        const serialSubmitBtn = document.getElementById('serial-submit-btn');
        const serialMessage = document.getElementById('serial-message');
        
        // ‰ΩøÁî®Ê∏à„Åø„Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„ÇíÁÆ°ÁêÜ
        let usedSerialCodes = JSON.parse(localStorage.getItem('usedSerialCodes') || '[]');
        
        serialSubmitBtn.addEventListener('click', () => {
            const code = serialInput.value.trim();
            
            if (!code) {
                serialMessage.textContent = '„Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                serialMessage.className = 'error';
                return;
            }
            
            // „Åô„Åß„Å´‰ΩøÁî®Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (usedSerialCodes.includes(code)) {
                serialMessage.textContent = '„Åì„ÅÆ„Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„ÅØÊó¢„Å´‰ΩøÁî®Ê∏à„Åø„Åß„Åô';
                serialMessage.className = 'error';
                return;
            }
            
            // „Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            let reward = null;
            
            if (code === 'otofu1022') {
                // Êòü30ÂÄã„ÄÅ„ÉÄ„Ç§„É§3ÂÄã„ÇíËøΩÂä†
                collectedStars = Math.min(collectedStars + 30, maxStars);
                collectedDiamonds = Math.min(collectedDiamonds + 3, maxDiamonds);
                reward = '‚ú® Êòü√ó30„ÄÅüíé√ó3 „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ';
            } else if (code === 'diamond5') {
                // „ÉÄ„Ç§„É§5ÂÄã„ÇíËøΩÂä†
                collectedDiamonds = Math.min(collectedDiamonds + 5, maxDiamonds);
                reward = 'üíé „ÉÄ„Ç§„É§√ó5 „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ';
            } else if (code === 'star30') {
                // Êòü30ÂÄã„ÇíËøΩÂä†
                collectedStars = Math.min(collectedStars + 30, maxStars);
                reward = '‚≠êÔ∏è Êòü√ó30 „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ';
            } else if (code === 'star50') {
                // Êòü50ÂÄã„ÇíËøΩÂä†
                collectedStars = Math.min(collectedStars + 50, maxStars);
                reward = '‚≠êÔ∏è Êòü√ó50 „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ';
            }
            
            if (reward) {
                // ‰ΩøÁî®Ê∏à„Åø„Ç≥„Éº„Éâ„Å´ËøΩÂä†
                usedSerialCodes.push(code);
                localStorage.setItem('usedSerialCodes', JSON.stringify(usedSerialCodes));
                
                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                updateStarCounter();
                updateDiamondCounter();
                saveGameData();
                
                serialMessage.textContent = reward;
                serialMessage.className = 'success';
                serialInput.value = '';
            } else {
                serialMessage.textContent = 'ÁÑ°Âäπ„Å™„Ç∑„É™„Ç¢„É´„Ç≥„Éº„Éâ„Åß„Åô';
                serialMessage.className = 'error';
            }
        });
        
        // Enter„Ç≠„Éº„Åß„ÇÇÈÄÅ‰ø°„Åß„Åç„Çã„Çà„ÅÜ„Å´
        serialInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                serialSubmitBtn.click();
            }
        });
        
        // ÂàùÊúü„ÅÆÊòü„ÇíÁîüÊàê
        for (let i = 0; i < 5; i++) {
            spawnCollectibleStars();
        }
        
        // ÂÆöÊúüÁöÑ„Å´Êòü„ÇíÁîüÊàê
        setInterval(() => {
            spawnCollectibleStars();
        }, 10000);
        
        // ÂÆöÊúüÁöÑ„Å´„Éú„Éº„Éä„ÇπÊúà„Çí„É©„É≥„ÉÄ„É†„ÅßÂá∫Áèæ„Åï„Åõ„Çã
        setInterval(() => {
            // 10%„ÅÆÁ¢∫Áéá„ÅßÂá∫Áèæ
            if (Math.random() < 0.1) {
                spawnBonusMoon();
            }
        }, 60000); // 1ÂàÜ„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        
        // ÂÆöÊúüÁöÑ„Å´Ë°åÂãï„É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        setInterval(updateActionMessage, 60000);
        
        // ÂÆöÊúüÁöÑ„Å´„É©„É≥„ÉÄ„É†„Çª„É™„Éï
        setInterval(() => {
            if (!speechBubble.classList.contains('show')) {
                const dialogue = getRandomDialogue();
                if (Math.random() < 0.2) {
                    showDialogue(dialogue);
                }
            }
        }, 25000);
    </script>
    </div></div>

<script>
/* === Portrait viewport fix (Android fullscreen / landscape issues) === */
(function () {
  const app = document.getElementById('app');

  function apply() {
    if (!app) return;
    const w = window.innerWidth;
    const h = window.innerHeight;
    const isLandscape = w > h;

    if (isLandscape) {
      // Keep the game upright by rotating the whole app back into portrait.
      app.style.width = h + 'px';
      app.style.height = w + 'px';
      app.style.transform = 'rotate(90deg)';
    } else {
      app.style.width = w + 'px';
      app.style.height = h + 'px';
      app.style.transform = 'none';
    }
  }

  async function tryLockPortrait() {
    try {
      if (screen.orientation && screen.orientation.lock) {
        await screen.orientation.lock('portrait');
      }
    } catch (e) {
      // iOS Safari: not allowed; Android: may require user gesture/fullscreen/PWA
    }
  }

  window.addEventListener('resize', apply, { passive: true });
  window.addEventListener('orientationchange', () => setTimeout(apply, 50), { passive: true });

  window.addEventListener('load', () => {
    apply();
    tryLockPortrait();
  });

  document.addEventListener('fullscreenchange', () => {
    apply();
    tryLockPortrait();
  });
})();
</script>

</body>
</html>
